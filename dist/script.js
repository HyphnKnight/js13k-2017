(function(){'use strict';function a(a,b=8){const c=h(10,b);return Math.round(a*c)/c}function b(b,d){const e=g(d),h=f(d);return[a(b[0]*h-b[1]*e),a(b[0]*e+b[1]*h)]}var c=Math.max,d=Math.min,e=Math.abs,f=Math.cos,g=Math.sin,h=Math.pow;const j=(...a)=>{let b=0;for(let c=a.length-1;0<=c;--c)b+=a[c];return b},k=(a)=>0<a?1:0>a?-1:0,l=(a)=>a*a,m=(a,b)=>(a[0]+=b[0],a[1]+=b[1],a),n=(a,b)=>[a[0]-b[0],a[1]-b[1]],o=(a,b)=>(a[0]-=b[0],a[1]-=b[1],a),p=(a)=>l(a[0])+l(a[1]),q=(a,b)=>{const c=[];for(let d=0,e=a.length;d<e;d+=2){const[e,f]=b([a[d],a[d+1]]);c[d]=e,c[d+1]=f}return c},r=(a,b)=>{const c=[];for(let d=0,e=a.length;d<e;d+=2)c[d]=a[d]+b[0],c[d+1]=a[d+1]+b[1];return c},s=(a,b)=>{for(let c=0,d=a.length;c<d;c+=2)a[c]+=b[0],a[c+1]+=b[1];return a},u=(a,b)=>{const c=[];for(let d=0,e=a.length;d<e;d+=2)c[d]=a[d]-b[0],c[d+1]=a[d+1]-b[1];return c},v=(b,d)=>{const e=[],h=g(d),j=f(d);for(let c=0,f=b.length;c<f;c+=2)e[c]=a(b[c]*j-b[c+1]*h),e[c+1]=a(b[c]*h+b[c+1]*j);return e},w=(a,b,c)=>r(v(u(a,b),c),b),x=()=>Math.random().toString(36).substr(2,9)+Math.random().toString(36).substr(2,9),y=(a,b)=>[-a/2,+b/2,-a/2,-b/2,+a/2,-b/2,+a/2,+b/2],z=(a,b=0,c=1,d=1,e=``)=>({id:x(),shape:`Rectangle`,label:e,position:a,rotation:b,width:c,height:d,points:y(c,d)}),A=document.querySelector(`canvas`),B=A.getContext(`2d`),C=320,D=240;let E=A.offsetWidth,F=A.offsetHeight,G=1,H=1;A.width=C,A.height=D;const I=()=>{const{top:a,left:b,width:c,height:d}=A.getBoundingClientRect();E=b,F=a,G=C/c,H=D/d};I(),window.addEventListener(`resize`,I);const J=[0,0],K=(b)=>(c)=>b.translate(a(c[0],0),a(c[1],0)),L=(a)=>(b)=>a.rotate(b),M=(b)=>(c,d,e)=>b.clearRect(a(c[0],0),a(c[1],0),a(d,0),a(e,0)),N=(a,b)=>()=>M(a)(J,b.width,b.height),O=(b)=>(c)=>b.moveTo(a(c[0],0),a(c[1],0)),P=(b)=>(c)=>b.lineTo(a(c[0],0),a(c[1],0)),Q=(b)=>(c,d)=>b.quadraticCurveTo(a(d[0],0),a(d[1],0),a(c[0],0),a(c[1],0)),R=(b)=>(c,d,e,f,g)=>b.arc(a(c[0],0),a(c[1],0),d,e,f,g),S=(b)=>(c,d,e)=>b.rect(a(c[0],0),a(c[1],0),a(d,0),a(e,0)),T=(b)=>(c)=>(d,e,f)=>b.drawImage(c,a(d[0],0),a(d[1],0),e,f),U=(b)=>(c)=>(d,e,f,g,h,i)=>b.drawImage(c,a(e[0],0),a(e[1],0),f,g,a(d[0],0),a(d[1],0),h,i),V=(a)=>(b,c=0)=>{const d=[b[0],b[1]],e=u(b,d);a.save(),K(a)(d),L(a)(c),O(a)([0,0]);for(let d=0;d<e.length;d+=2)P(a)([e[d],e[d+1]]);a.restore()},W=(a)=>(b,c,d=0)=>{a.save(),K(a)(b),L(a)(d),O(a)([c[c.length-2],c[c.length-1]]);for(let e=0;e<c.length;e+=2)P(a)([c[e],c[e+1]]);a.restore()},X=(b)=>(c,d,e,f=0)=>{b.save(),K(b)(c),L(b)(f),S(b)([-d/2,-e/2],a(d,0),a(e,0)),b.restore()},Y=(a)=>(b,c,d=100,e=0,f=2*Math.PI,g=!1)=>{a.save(),K(a)(b),L(a)(c),R(a)([0,0],d,e,f,g),a.restore()},Z=(a)=>(b)=>(c,...d)=>{b.save(),b.beginPath(),b.fillStyle=c,a(b)(...d),b.fill(),b.restore()},$=(a)=>(b)=>(c,...d)=>{b.save(),b.beginPath(),b.strokeStyle=c,a(b)(...d),b.stroke(),b.restore()},_=Z(W),aa=Z(X),ba=Z(V),ca=Z(Y),da=$(W),ea=$(X),fa=$(V),ga=$(Y),ha=(b)=>(c,d,e)=>{b.save(),b.strokeStyle=c.style||'',b.font=c.font||b.font,b.textAlign=c.textAlign||b.textAlign,b.textBaseline=c.textBaseline||b.textBaseline,b.strokeText(e,a(d[0],0),a(d[1],0),c.maxWidth),b.restore()},ia=(b)=>(c,d,e)=>{b.save(),b.fillStyle=c.style||'',b.font=c.font||b.font,b.textAlign=c.textAlign||b.textAlign,b.textBaseline=c.textBaseline||b.textBaseline,b.fillText(e,a(d[0],0),a(d[1],0),c.maxWidth),b.restore()},ja=(a)=>({ctx:a,canvas:a.canvas,translate:K(a),rotate:L(a),moveTo:O(a),lineTo:P(a),quadraticCurveTo:Q(a),arc:R(a),drawLine:V(a),drawPolygon:W(a),drawArc:Y(a),drawImage:T(a),drawSlicedImage:U(a),fillRectangle:aa(a),fillPolygon:_(a),fillLine:ba(a),fillArc:ca(a),fillText:ia(a),strokePolygon:da(a),strokeRectangle:ea(a),strokeLine:fa(a),strokeArc:ga(a),strokeText:ha(a),clearRect:M(a),clear:N(a,a.canvas)});class ka{constructor(){this.position=J,this.rotation=0,this.saved_positions=[],this.saved_rotations=[]}apply(a){const b=[this.position[0],this.position[1]],c=this.rotation;return Object.assign(Object.create(null),a,{id:x(),position:b,rotation:c})}save(){this.saved_positions.push([this.position[0],this.position[1]]),this.saved_rotations.push(this.rotation)}restore(){if(0<this.saved_positions.length){const a=this.saved_positions.pop();!a||(this.position[0]=a[0],this.position[1]=a[1]);const b=this.saved_rotations.pop();!b&&0!==b||(this.rotation=b)}}}const la=(a,b)=>k((b[2]-b[0])*(a[1]-b[1])-(b[3]-b[1])*(a[0]-b[0])),ma=(a,b,c)=>p(n(a,b))<=l(c),na=(a,b,c,d)=>e(a[0]-b[0])<=c/2&&e(a[1]-b[1])<=d/2,oa=(a,b)=>{const c=Math.floor(b.length/2);for(let d=0;d<c;d+=2){const e=d==c-1?0:d+1;if(-1===la(a,[b[d],b[d+1],b[e],b[e+1]]))return!0}return!1},pa=(a,b,e,f,g)=>na(a,e,f,g)||ma(e,a,b)||l(a[0]-c(e[0],d(a[0],e[0]+f)))+l(a[1]-c(e[1],d(a[1],e[1]+g)))<l(b),qa=(a,b,c,d,f,g)=>!(e(d[0]-a[0])>b/2+f/2||e(d[1]-a[1])>c/2+g/2),ra=(a,b,d,e)=>{if(oa(a,e)||oa(d,b))return!0;const f=c(b.length,e.length);for(let c=0;c<f;c+=2)if(c<b.length&&oa([b[c],b[c+1]],e)||c<e.length&&oa([e[c],e[c+1]],b))return!0;return!1},sa=new Map,ta=new Map,ua=new Map,va=z([0,0],0,window.innerWidth,window.innerHeight,`window`);window.onresize=()=>Object.assign(va,z([0,0],0,window.innerWidth,window.innerHeight,`window`));const wa=((a=va)=>(b)=>{const{geometry:c={shape:null}}=b;switch(c.shape){case`Circle`:return pa(c.position,c.radius,a.position,a.width,a.height);case`Rectangle`:return qa(c.position,c.width,c.height,a.position,a.width,a.height);case`Polygon`:return ra(c.position,s(w(c.points,[0,0],c.rotation),c.position),a.position,s(w(a.points,[0,0],a.rotation),a.position));default:return!0;}})(va),xa=(a,c)=>(d)=>{const{geometry:e,children:f,render:g,interact:h}=d,{ctx:i,translate:j,rotate:k}=c;i.save(),a.save(),e&&(j(e.position),m(a.position,b(e.position,a.rotation)),k(e.rotation),a.rotation+=e.rotation),i.save(),g&&(!e||wa(a.apply(e)))&&g(c,d),i.restore(),f&&f.forEach(xa(a,c)),h&&(h.onMouseDown?sa.set(d,[d,e&&a.apply(e),h.onMouseDown]):sa.delete(d),h.onMouseMove?ta.set(d,[d,e&&a.apply(e),h.onMouseMove]):ta.delete(d),h.onMouseUp?ua.set(d,[d,e&&a.apply(e),h.onMouseUp]):ua.delete(d)),i.restore(),a.restore()},ya=`ontouchstart`in window,za=(a)=>{if(a.clientX)return[a.clientX,a.clientY];else{const b=a.touches[0];return[b.clientX,b.clientY]}},Aa=(a)=>(b)=>{switch(b.shape){case`Circle`:return ma(a,b.position,b.radius);case`Rectangle`:return na(a,b.position,b.width,b.height);case`Polygon`:return oa(a,s(w(b.points,[0,0],b.rotation),b.position));default:return!1;}},Ba=(a)=>(b)=>{if(a.size){const c=o(za(b),[E,F]);c[0]*=G,c[1]*=H;const d=Aa(c);[...a.values()].filter(([a,b])=>!b||d(b)).forEach(([a,b,d])=>d(a,c))}},Ca=`#fff`,Da=`Arial Black, Gadget, sans-serif`,Ea=`"Lucida Console", Monaco, monospace`,Fa=`24px ${Da}`,Ga=`12px ${Ea}`,Ha={38:`up`,40:`down`,37:`left`,39:`right`,81:`q`,87:`w`,69:`e`,65:`a`,83:`s`,68:`d`,48:`0`,49:`1`,50:`2`,51:`3`,52:`4`,53:`5`,54:`6`,55:`7`,56:`8`,57:`9`,189:`-`,187:`=`,32:`space`,13:`return`,16:`shift`,17:`ctrl`,9:`tab`,18:`alt`},Ia={up:!1,down:!1,left:!1,right:!1,q:!1,w:!1,e:!1,a:!1,s:!1,d:!1,0:!1,1:!1,2:!1,3:!1,4:!1,5:!1,6:!1,7:!1,8:!1,9:!1,"-":!1,"=":!1,space:!1,return:!1,shift:!1,ctrl:!1,tab:!1,alt:!1,click:!1},Ja=(a,b=!0)=>{const c=Ha[a];return c&&(Ia[c]=b),Ia[c]};document.body.onkeyup=({keyCode:a})=>Ja(a,!1),document.body.onkeydown=({keyCode:a})=>Ja(a,!0);let Ka=0;const La=(a,b,c)=>({geometry:z(c,0,140,14),render:(a,c)=>{const{fillRectangle:d,fillText:e,ctx:f}=a;f.font=Ga;const{width:g}=f.measureText(b);c.geometry.width=g+10,c.geometry.points=y(c.geometry.width,c.geometry.height),e({textBaseline:`middle`,font:Ga,style:Ca},[-g/2,0],b)},interact:{onMouseMove:()=>Ka=a,onMouseDown:()=>Ka=a}}),Ma={geometry:z([C/2,D/2],0,140,40),children:[La(0,`new game`,[0,48]),La(1,`continue game`,[0,72])],render:(a)=>{const{fillText:b,fillPolygon:c}=a;b({textBaseline:`middle`,style:Ca,font:Fa},[-59,0],`A L T E R`),400<Date.now()%600&&c(`white`,0===Ka?[-42,48]:[-60,72],[-5,3,5,0,-5,-3]),(Ia.up||Ia.w)&&(Ka=0),(Ia.down||Ia.s)&&(Ka=1)}},Na={dialog:[['Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris mattis purus sed luctus dignissim. Phasellus hendrerit quam et urna tempor, eu porttitor dui feugiat. Praesent vestibulum est lectus, et vehicula velit laoreet non.']]};let Oa=!1;const Pa=2,Qa=C-Pa,Ra=D/4,Sa=`#fff`,Ta=`#00f`,Ua=12,Va=1.2*Ua,Wa=Qa-4*Pa,Xa=Ra-4*Pa,Ya=`#fff`,Za=(a,b)=>{const c=[];b=b.toUpperCase(),a.textBaseline=`top`,a.font=`${Ua}px monospace`;const d=b.split(` `);let e=``,f=0;for(const[g,h]of d.entries()){const b=`${e+h} `,d=a.measureText(b),i=d.width;i>Wa&&0<g?(c.push([-Wa/2,-Xa/2+f,e]),e=`${h} `,f+=Va):e=b}return c.push([-Wa/2,-Xa/2+f,e]),c},$a={geometry:z([C/2,D-Ra/2],0,Qa,Ra),render:(a,{geometry:b})=>{const{dialog:c}=Na;if(!c.length)return;const{ctx:d,fillRectangle:e,strokeRectangle:f,fillText:g}=a;e(Ta,[0,0],b.width,b.height),f(Sa,[0,0],b.width,b.height);const[h,i]=c[0],j=Za(d,h);let k=0;if(i){const[a,b]=i,{width:c}=d.measureText(b),h=c+16+4*Pa,j=-Qa/2+c,l=-Ra/2-2*Pa;e(Ta,[j,l],h,Va+4*Pa),f(Sa,[j,l],h,Va+4*Pa),d.font=`${Ua}px monospace`,g({style:Ya},[j-6+4*Pa-h/2,l-Va/2],a),g({style:Ya},[j-6+4*Pa-h/2+16,l-Va/2],b),k=Va/2}j.forEach(([a,b,c])=>{g({style:Ya},[a,b+k],c)}),Ia.space&&!Oa?(Na.dialog.shift(),Oa=!0):!Ia.space&&Oa&&(Oa=!1)},interact:{onMouseDown:()=>Na.dialog.shift()}},{palette:_a,render:ab}=((a,b)=>{const c=ja(a.getContext(`2d`));return c.clear(),a.addEventListener(ya?`ontouchstart`:`mousedown`,Ba(sa)),a.addEventListener(ya?`ontouchmove`:`mousemove`,Ba(ta)),a.addEventListener(ya?`ontouchend`:`mouseup`,Ba(ua)),{palette:c,render:()=>xa(new ka,c)(b)}})(A,{geometry:z([0,0],0,window.innerWidth,window.innerHeight),children:[$a]});_a.ctx.imageSmoothingEnabled=!1;const bb=([a,b,c])=>([d,e])=>[d+e*(a-d)/(e+b)-a+C/2,D-(0===b+e?0:c*e/(b+e)),Math.sqrt(h(b+e,2)+h(a-d,2))],cb=`\uD83D\uDC69\uD83C\uDFFB\u200D\uD83C\uDFA4`,db=`\uD83C\uDF32`,eb=`\uD83C\uDF33`,fb=`\u2601\uFE0F`,gb=(a)=>([b,c],d=0)=>[b,c,d,a],hb=gb(db),ib=gb(eb),jb=gb(fb);let kb=0,lb=0;const t=z([0,800],0,1e4,1600),mb=z([0,0],0,2*C,2*D),{fillText:nb,fillPolygon:ob,strokePolygon:pb,fillArc:qb}=_a,rb=()=>Date.now()%6e3/20-150,sb=()=>120,tb=()=>Date.now()%6e3/30-20,ub=()=>[rb(),sb(),tb()],vb=_a.ctx.createLinearGradient(0,0,200,200);vb.addColorStop(0,`#5E8C6A`),vb.addColorStop(1,`#BFB35A`);const wb=_a.ctx.createLinearGradient(0,0,200,200);wb.addColorStop(0,`#69D2E7`),wb.addColorStop(1,`#A7DBD8`);const xb=[];let yb=1e3;for(;0<--yb;)xb.push((0.5<Math.random()?hb:ib)([5120*Math.random()-2560,1280*Math.random()],0));for(yb=25;0<--yb;)xb.push(jb([1e4*Math.random()-5e3,1e3*Math.random()+3500],30*Math.random()+10));requestAnimationFrame(function a(){kb=d(16,Date.now()-lb),_a.clear();const b=bb(ub());ob(wb,[0,0],mb.points),ob(vb,[0,0],q(r(t.points,t.position),b)),[...xb].map((a)=>[...b(a),a[2],a[3],a[4]]).sort((c,a)=>a[2]-c[2]).forEach(([a,b,c,d,e])=>nb({},[a,b-d],e)),nb({font:`16px`},b([20,20]),cb),ab(),lb=Date.now(),requestAnimationFrame(a)})})();
(function(){'use strict';function a(a,b=8){const c=h(10,b);return Math.round(a*c)/c}function b(b,d){const e=g(d),h=f(d);return[a(b[0]*h-b[1]*e),a(b[0]*e+b[1]*h)]}var c=Math.max,d=Math.min,e=Math.abs,f=Math.cos,g=Math.sin,h=Math.pow;const j=(...a)=>{let b=0;for(let c=a.length-1;0<=c;--c)b+=a[c];return b},k=(a)=>0<a?1:0>a?-1:0,l=(a)=>a*a,m=(a,b)=>(a[0]+=b[0],a[1]+=b[1],a),n=(a,b)=>[a[0]-b[0],a[1]-b[1]],o=(a)=>l(a[0])+l(a[1]),p=(a,b)=>{const c=[];for(let d=0,e=a.length;d<e;d+=2){const[e,f]=b([a[d],a[d+1]]);c[d]=e,c[d+1]=f}return c},q=(a,b)=>{const c=[];for(let d=0,e=a.length;d<e;d+=2)c[d]=a[d]+b[0],c[d+1]=a[d+1]+b[1];return c},r=(a,b)=>{for(let c=0,d=a.length;c<d;c+=2)a[c]+=b[0],a[c+1]+=b[1];return a},s=(a,b)=>{const c=[];for(let d=0,e=a.length;d<e;d+=2)c[d]=a[d]-b[0],c[d+1]=a[d+1]-b[1];return c},t=(b,d)=>{const e=[],h=g(d),j=f(d);for(let c=0,f=b.length;c<f;c+=2)e[c]=a(b[c]*j-b[c+1]*h),e[c+1]=a(b[c]*h+b[c+1]*j);return e},u=(a,b,c)=>q(t(s(a,b),c),b),v=()=>Math.random().toString(36).substr(2,9)+Math.random().toString(36).substr(2,9),w=(a,b)=>[-a/2,+b/2,-a/2,-b/2,+a/2,-b/2,+a/2,+b/2],x=(a,b=0,c=1,d=1,e='')=>({id:v(),shape:'Rectangle',label:e,position:a,rotation:b,width:c,height:d,points:w(c,d)}),y=[0,0],z=(b)=>(c)=>b.translate(a(c[0],0),a(c[1],0)),A=(a)=>(b)=>a.rotate(b),B=(b)=>(c,d,e)=>b.clearRect(a(c[0],0),a(c[1],0),a(d,0),a(e,0)),C=(a,b)=>()=>B(a)(y,b.width,b.height),D=(b)=>(c)=>b.moveTo(a(c[0],0),a(c[1],0)),E=(b)=>(c)=>b.lineTo(a(c[0],0),a(c[1],0)),F=(b)=>(c,d)=>b.quadraticCurveTo(a(d[0],0),a(d[1],0),a(c[0],0),a(c[1],0)),G=(b)=>(c,d,e,f,g)=>b.arc(a(c[0],0),a(c[1],0),d,e,f,g),H=(b)=>(c,d,e)=>b.rect(a(c[0],0),a(c[1],0),a(d,0),a(e,0)),I=(b)=>(c)=>(d,e,f)=>b.drawImage(c,a(d[0],0),a(d[1],0),e,f),J=(b)=>(c)=>(d,e,f,g,h,i)=>b.drawImage(c,a(e[0],0),a(e[1],0),f,g,a(d[0],0),a(d[1],0),h,i),K=(a)=>(b,c=0)=>{const d=[b[0],b[1]],e=s(b,d);a.save(),z(a)(d),A(a)(c),D(a)([0,0]);for(let d=0;d<e.length;d+=2)E(a)([e[d],e[d+1]]);a.restore()},L=(a)=>(b,c,d=0)=>{a.save(),z(a)(b),A(a)(d),D(a)([c[c.length-2],c[c.length-1]]);for(let e=0;e<c.length;e+=2)E(a)([c[e],c[e+1]]);a.restore()},M=(b)=>(c,d,e,f=0)=>{b.save(),z(b)(c),A(b)(f),H(b)([-d/2,-e/2],a(d,0),a(e,0)),b.restore()},N=(a)=>(b,c,d=100,e=0,f=2*Math.PI,g=!1)=>{a.save(),z(a)(b),A(a)(c),G(a)(y,d,e,f,g),a.restore()},O=(a)=>(b)=>(c,...d)=>{b.save(),b.beginPath(),b.fillStyle=c,a(b)(...d),b.fill(),b.restore()},P=(a)=>(b)=>(c,...d)=>{b.save(),b.beginPath(),b.strokeStyle=c,a(b)(...d),b.stroke(),b.restore()},Q=O(L),R=O(M),S=O(K),T=O(N),U=P(L),V=P(M),W=P(K),X=P(N),Y=(b)=>(c,d,e)=>{b.save(),b.strokeStyle=c.style||'',b.font=c.font||b.font,b.textAlign=c.textAlign||b.textAlign,b.textBaseline=c.textBaseline||b.textBaseline,b.strokeText(e,a(d[0],0),a(d[1],0),c.maxWidth),b.restore()},Z=(b)=>(c,d,e)=>{b.save(),b.fillStyle=c.style||'',b.font=c.font||b.font,b.textAlign=c.textAlign||b.textAlign,b.textBaseline=c.textBaseline||b.textBaseline,b.fillText(e,a(d[0],0),a(d[1],0),c.maxWidth),b.restore()},$=(a)=>({ctx:a,canvas:a.canvas,translate:z(a),rotate:A(a),moveTo:D(a),lineTo:E(a),quadraticCurveTo:F(a),arc:G(a),drawLine:K(a),drawPolygon:L(a),drawArc:N(a),drawImage:I(a),drawSlicedImage:J(a),fillRectangle:R(a),fillPolygon:Q(a),fillLine:S(a),fillArc:T(a),fillText:Z(a),strokePolygon:U(a),strokeRectangle:V(a),strokeLine:W(a),strokeArc:X(a),strokeText:Y(a),clearRect:B(a),clear:C(a,a.canvas)});class _{constructor(){this.position=y,this.rotation=0,this.saved_positions=[],this.saved_rotations=[]}apply(a){const b=[this.position[0],this.position[1]],c=this.rotation;return Object.assign(Object.create(null),a,{id:v(),position:b,rotation:c})}save(){this.saved_positions.push([this.position[0],this.position[1]]),this.saved_rotations.push(this.rotation)}restore(){if(0<this.saved_positions.length){const a=this.saved_positions.pop();!a||(this.position[0]=a[0],this.position[1]=a[1]);const b=this.saved_rotations.pop();!b&&0!==b||(this.rotation=b)}}}const aa=(a,b)=>k((b[2]-b[0])*(a[1]-b[1])-(b[3]-b[1])*(a[0]-b[0])),ba=(a,b,c)=>o(n(a,b))<=l(c),ca=(a,b,c,d)=>e(a[0]-b[0])<=c/2&&e(a[1]-b[1])<=d/2,da=(a,b)=>{const c=Math.floor(b.length/2);for(let d=0;d<c;d+=2){const e=d==c-1?0:d+1;if(-1===aa(a,[b[d],b[d+1],b[e],b[e+1]]))return!0}return!1},ea=(a,b,e,f,g)=>ca(a,e,f,g)||ba(e,a,b)||l(a[0]-c(e[0],d(a[0],e[0]+f)))+l(a[1]-c(e[1],d(a[1],e[1]+g)))<l(b),fa=(a,b,c,d,f,g)=>!(e(d[0]-a[0])>b/2+f/2||e(d[1]-a[1])>c/2+g/2),ga=(a,b,d,e)=>{if(da(a,e)||da(d,b))return!0;const f=c(b.length,e.length);for(let c=0;c<f;c+=2)if(c<b.length&&da([b[c],b[c+1]],e)||c<e.length&&da([e[c],e[c+1]],b))return!0;return!1},ha=new Map,ia=new Map,ja=new Map;let ka=x([0,0],0,window.innerWidth,window.innerHeight,'window');window.onresize=()=>Object.assign(ka,x([0,0],0,window.innerWidth,window.innerHeight,'window'));const la=((a=ka)=>(b)=>{const{geometry:c={shape:null}}=b;switch(c.shape){case'Circle':return ea(c.position,c.radius,a.position,a.width,a.height);case'Rectangle':return fa(c.position,c.width,c.height,a.position,a.width,a.height);case'Polygon':return ga(c.position,r(u(c.points,[0,0],c.rotation),c.position),a.position,r(u(a.points,[0,0],a.rotation),a.position));default:return!0;}})(ka),ma=(a,c)=>(d)=>{const{geometry:e,children:f,render:g,interact:h}=d,{ctx:i,translate:j,rotate:k}=c;i.save(),a.save(),!e||(j(e.position),m(a.position,b(e.position,a.rotation)),k(e.rotation),a.rotation+=e.rotation),i.save(),g&&(!e||la(a.apply(e)))&&g(c,d),i.restore(),f&&f.forEach(ma(a,c)),h&&(h.onMouseDown?ha.set(d,[d,e&&a.apply(e),h.onMouseDown]):ha.delete(d),h.onMouseMove?ia.set(d,[d,e&&a.apply(e),h.onMouseMove]):ia.delete(d),h.onMouseUp?ja.set(d,[d,e&&a.apply(e),h.onMouseUp]):ja.delete(d)),i.restore(),a.restore()},na='ontouchstart'in window,oa=(a)=>{if(!!a.clientX)return[a.clientX,a.clientY];else{const b=a.touches[0];return[b.clientX,b.clientY]}},pa=(a)=>(b)=>{switch(b.shape){case'Circle':return ba(a,b.position,b.radius);case'Rectangle':return ca(a,b.position,b.width,b.height);case'Polygon':return da(a,r(u(b.points,[0,0],b.rotation),b.position));default:return!1;}},qa=(a)=>(b)=>{if(!!a.size){const c=oa(b),d=pa(c);[...a.values()].filter(([a,b])=>!b||d(b)).forEach(([a,b,d])=>d(a,c))}},ra={9:'tab',13:'return',16:'shift',17:'ctrl',18:'alt',32:'space',37:'left',38:'up',39:'right',40:'down',48:'0',49:'1',50:'2',51:'3',52:'4',53:'5',54:'6',55:'7',56:'8',57:'9',65:'a',68:'d',69:'e',81:'q',83:'s',87:'w',187:'=',189:'-'},sa={up:!1,down:!1,left:!1,right:!1,q:!1,w:!1,e:!1,a:!1,s:!1,d:!1,0:!1,1:!1,2:!1,3:!1,4:!1,5:!1,6:!1,7:!1,8:!1,9:!1,"-":!1,"=":!1,space:!1,return:!1,shift:!1,ctrl:!1,tab:!1,alt:!1,click:!1},ta=(a,b=!0)=>{const c=ra[a];return!c||(sa[c]=b),sa[c]};document.body.onkeyup=({keyCode:a})=>ta(a,!1),document.body.onkeydown=({keyCode:a})=>ta(a,!0);const ua=x([0,0],0,100,100),va=(([a,b,c])=>([d,e])=>[c*e/(e+b),e/((b+e)/a-d)])([50,20,10]),wa={geometry:x([160,120],0,140,40),children:[],render:(a)=>{const{fillText:b,fillPolygon:c,strokePolygon:d}=a;d('red',[0,0],q(ua.points,ua.position)),d('green',[0,0],p(q(ua.points,ua.position),va))}},xa=document.querySelector('canvas');xa.width=320,xa.height=240;const{palette:ya,render:za}=((a,b)=>{const c=$(a.getContext('2d'));return c.clear(),a.addEventListener(na?'ontouchstart':'mousedown',qa(ha)),a.addEventListener(na?'ontouchmove':'mousemove',qa(ia)),a.addEventListener(na?'ontouchend':'mouseup',qa(ja)),{palette:c,render:()=>ma(new _,c)(b)}})(xa,{geometry:x([0,0],0,window.innerWidth,window.innerHeight),children:[wa]});ya.ctx.imageSmoothingEnabled=!1;const Aa=([a,b,c])=>([d,e])=>[d+e*(a-d)/(e+b)-a+160,240-(0===b+e?0:c*e/(b+e)),Math.sqrt(h(b+e,2)+h(a-d,2))],Ba=(a)=>([b,c],d=0)=>[b,c,a,d],Ca=Ba('\uD83C\uDF32'),Da=Ba('\uD83C\uDF33'),Ea=Ba('\u2601\uFE0F'),Fa=x([0,800],0,1e4,1600),Ga=x([0,0],0,window.innerWidth,window.innerHeight),{fillText:Ha,fillPolygon:Ia,strokePolygon:Ja,fillArc:Ka}=ya,La=()=>Date.now()%6e3/20-150,Ma=()=>120,Na=()=>Date.now()%6e3/30-20,Oa=()=>[La(),Ma(),Na()],Pa=ya.ctx.createLinearGradient(0,0,200,200);Pa.addColorStop(0,'#5E8C6A'),Pa.addColorStop(1,'#BFB35A');const Qa=ya.ctx.createLinearGradient(0,0,200,200);Qa.addColorStop(0,'#69D2E7'),Qa.addColorStop(1,'#A7DBD8');const Ra=[];let Sa=1e3;for(;0<--Sa;)Ra.push((0.5<Math.random()?Ca:Da)([5120*Math.random()-2560,1280*Math.random()],0));for(Sa=25;0<--Sa;)Ra.push(Ea([1e4*Math.random()-5e3,1e3*Math.random()+3500],30*Math.random()+10));requestAnimationFrame(function a(){ya.clear();const b=Aa(Oa());Ia(Qa,[0,0],Ga.points),Ia(Pa,[0,0],p(q(Fa.points,Fa.position),b)),[...Ra].map((a)=>[...b(a),a[2],a[3],a[4]]).sort((c,a)=>a[2]-c[2]).forEach(([a,b,c,d,e])=>Ha({},[a,b-e],d)),Ha({font:`16px`},b([20,20]),'\uD83D\uDC69\uD83C\uDFFB\u200D\uD83C\uDFA4'),requestAnimationFrame(a)})})();
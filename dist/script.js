(function(){'use strict';function a(a,b=8){const c=Math.pow(10,b);return Math.round(a*c)/c}function b(b,d){const e=g(d),h=f(d);return[a(b[0]*h-b[1]*e),a(b[0]*e+b[1]*h)]}var c=Math.max,d=Math.min,e=Math.abs,f=Math.cos,g=Math.sin;const h=(...a)=>{let b=0;for(let c=a.length-1;0<=c;--c)b+=a[c];return b},i=(a)=>0<a?1:0>a?-1:0,j=(a)=>a*a,k=(a,b)=>(a[0]+=b[0],a[1]+=b[1],a),l=(a,b)=>[a[0]-b[0],a[1]-b[1]],m=(a)=>j(a[0])+j(a[1]),n=(a,b)=>{const c=[];for(let d=0,e=a.length;d<e;d+=2)c[d]=a[d]+b[0],c[d+1]=a[d+1]+b[1];return c},o=(a,b)=>{for(let c=0,d=a.length;c<d;c+=2)a[c]+=b[0],a[c+1]+=b[1];return a},p=(a,b)=>{const c=[];for(let d=0,e=a.length;d<e;d+=2)c[d]=a[d]-b[0],c[d+1]=a[d+1]-b[1];return c},q=(b,d)=>{const e=[],h=g(d),j=f(d);for(let c=0,f=b.length;c<f;c+=2)e[c]=a(b[c]*j-b[c+1]*h),e[c+1]=a(b[c]*h+b[c+1]*j);return e},r=(a,b,c)=>n(q(p(a,b),c),b),s=()=>Math.random().toString(36).substr(2,9)+Math.random().toString(36).substr(2,9),u=(a,b)=>[-a/2,+b/2,-a/2,-b/2,+a/2,-b/2,+a/2,+b/2],v=(a,b=0,c=1,d=1,e='')=>({id:s(),shape:'Rectangle',label:e,position:a,rotation:b,width:c,height:d,points:u(c,d)}),w=[0,0],x=(b)=>(c)=>b.translate(a(c[0],0),a(c[1],0)),y=(a)=>(b)=>a.rotate(b),z=(b)=>(c,d,e)=>b.clearRect(a(c[0],0),a(c[1],0),a(d,0),a(e,0)),A=(a,b)=>()=>z(a)(w,b.width,b.height),B=(b)=>(c)=>b.moveTo(a(c[0],0),a(c[1],0)),C=(b)=>(c)=>b.lineTo(a(c[0],0),a(c[1],0)),D=(b)=>(c,d)=>b.quadraticCurveTo(a(d[0],0),a(d[1],0),a(c[0],0),a(c[1],0)),E=(b)=>(c,d,e,f,g)=>b.arc(a(c[0],0),a(c[1],0),d,e,f,g),F=(b)=>(c,d,e)=>b.rect(a(c[0],0),a(c[1],0),a(d,0),a(e,0)),G=(b)=>(c)=>(d,e,f)=>b.drawImage(c,a(d[0],0),a(d[1],0),e,f),H=(b)=>(c)=>(d,e,f,g,h,i)=>b.drawImage(c,a(e[0],0),a(e[1],0),f,g,a(d[0],0),a(d[1],0),h,i),I=(a)=>(b,c=0)=>{const d=[b[0],b[1]],e=p(b,d);a.save(),x(a)(d),y(a)(c),B(a)([0,0]);for(let d=0;d<e.length;d+=2)C(a)([e[d],e[d+1]]);a.restore()},J=(a)=>(b,c,d=0)=>{a.save(),x(a)(b),y(a)(d),B(a)([c[c.length-2],c[c.length-1]]);for(let e=0;e<c.length;e+=2)C(a)([c[e],c[e+1]]);a.restore()},K=(b)=>(c,d,e,f=0)=>{b.save(),x(b)(c),y(b)(f),F(b)([-d/2,-e/2],a(d,0),a(e,0)),b.restore()},L=(a)=>(b,c,d=100,e=0,f=2*Math.PI,g=!1)=>{a.save(),x(a)(b),y(a)(c),E(a)(w,d,e,f,g),a.restore()},M=(a)=>(b)=>(c,...d)=>{b.save(),b.beginPath(),b.fillStyle=c,a(b)(...d),b.fill(),b.restore()},N=(a)=>(b)=>(c,...d)=>{b.save(),b.beginPath(),b.strokeStyle=c,a(b)(...d),b.stroke(),b.restore()},O=M(J),P=M(K),Q=M(I),R=M(L),S=N(J),T=N(K),U=N(I),V=N(L),W=(b)=>(c,d,e)=>{b.save(),b.strokeStyle=c.style||'',b.font=c.font||b.font,b.textAlign=c.textAlign||b.textAlign,b.textBaseline=c.textBaseline||b.textBaseline,b.strokeText(e,a(d[0],0),a(d[1],0),c.maxWidth),b.restore()},X=(b)=>(c,d,e)=>{b.save(),b.fillStyle=c.style||'',b.font=c.font||b.font,b.textAlign=c.textAlign||b.textAlign,b.textBaseline=c.textBaseline||b.textBaseline,b.fillText(e,a(d[0],0),a(d[1],0),c.maxWidth),b.restore()},Y=(a)=>({ctx:a,canvas:a.canvas,translate:x(a),rotate:y(a),moveTo:B(a),lineTo:C(a),quadraticCurveTo:D(a),arc:E(a),drawLine:I(a),drawPolygon:J(a),drawArc:L(a),drawImage:G(a),drawSlicedImage:H(a),fillRectangle:P(a),fillPolygon:O(a),fillLine:Q(a),fillArc:R(a),fillText:X(a),strokePolygon:S(a),strokeRectangle:T(a),strokeLine:U(a),strokeArc:V(a),strokeText:W(a),clearRect:z(a),clear:A(a,a.canvas)});class Z{constructor(){this.position=w,this.rotation=0,this.saved_positions=[],this.saved_rotations=[]}apply(a){const b=[this.position[0],this.position[1]],c=this.rotation;return Object.assign(Object.create(null),a,{id:s(),position:b,rotation:c})}save(){this.saved_positions.push([this.position[0],this.position[1]]),this.saved_rotations.push(this.rotation)}restore(){if(0<this.saved_positions.length){const a=this.saved_positions.pop();!a||(this.position[0]=a[0],this.position[1]=a[1]);const b=this.saved_rotations.pop();!b&&0!==b||(this.rotation=b)}}}const $=(a,b)=>i((b[2]-b[0])*(a[1]-b[1])-(b[3]-b[1])*(a[0]-b[0])),_=(a,b,c)=>m(l(a,b))<=j(c),aa=(a,b,c,d)=>e(a[0]-b[0])<=c/2&&e(a[1]-b[1])<=d/2,ba=(a,b)=>{const c=Math.floor(b.length/2);for(let d=0;d<c;d+=2){const e=d==c-1?0:d+1;if(-1===$(a,[b[d],b[d+1],b[e],b[e+1]]))return!0}return!1},ca=(a,b,e,f,g)=>aa(a,e,f,g)||_(e,a,b)||j(a[0]-c(e[0],d(a[0],e[0]+f)))+j(a[1]-c(e[1],d(a[1],e[1]+g)))<j(b),da=(a,b,c,d,f,g)=>!(e(d[0]-a[0])>b/2+f/2||e(d[1]-a[1])>c/2+g/2),ea=(a,b,d,e)=>{if(ba(a,e)||ba(d,b))return!0;const f=c(b.length,e.length);for(let c=0;c<f;c+=2)if(c<b.length&&ba([b[c],b[c+1]],e)||c<e.length&&ba([e[c],e[c+1]],b))return!0;return!1},fa=new Map,ga=new Map,ha=new Map;let ia=v([0,0],0,window.innerWidth,window.innerHeight,'window');window.onresize=()=>Object.assign(ia,v([0,0],0,window.innerWidth,window.innerHeight,'window'));const ja=((a=ia)=>(b)=>{const{geometry:c={shape:null}}=b;switch(c.shape){case'Circle':return ca(c.position,c.radius,a.position,a.width,a.height);case'Rectangle':return da(c.position,c.width,c.height,a.position,a.width,a.height);case'Polygon':return ea(c.position,o(r(c.points,[0,0],c.rotation),c.position),a.position,o(r(a.points,[0,0],a.rotation),a.position));default:return!0;}})(ia),ka=(a,c)=>(d)=>{const{geometry:e,children:f,render:g,interact:h}=d,{ctx:i,translate:j,rotate:l}=c;i.save(),a.save(),!e||(j(e.position),k(a.position,b(e.position,a.rotation)),l(e.rotation),a.rotation+=e.rotation),i.save(),g&&(!e||ja(a.apply(e)))&&g(c,d),i.restore(),f&&f.forEach(ka(a,c)),h&&(h.onMouseDown?fa.set(d,[d,e&&a.apply(e),h.onMouseDown]):fa.delete(d),h.onMouseMove?ga.set(d,[d,e&&a.apply(e),h.onMouseMove]):ga.delete(d),h.onMouseUp?ha.set(d,[d,e&&a.apply(e),h.onMouseUp]):ha.delete(d)),i.restore(),a.restore()},la='ontouchstart'in window,ma=(a)=>{if(!!a.clientX)return[a.clientX,a.clientY];else{const b=a.touches[0];return[b.clientX,b.clientY]}},na=(a)=>(b)=>{switch(b.shape){case'Circle':return _(a,b.position,b.radius);case'Rectangle':return aa(a,b.position,b.width,b.height);case'Polygon':return ba(a,o(r(b.points,[0,0],b.rotation),b.position));default:return!1;}},oa=(a)=>(b)=>{if(!!a.size){const c=ma(b),d=na(c);[...a.values()].filter(([a,b])=>!b||d(b)).forEach(([a,b,d])=>d(a,c))}},pa='#fff',qa='12px '+'Helvetica, sans-serif',ra={9:'tab',13:'return',16:'shift',17:'ctrl',18:'alt',32:'space',37:'left',38:'up',39:'right',40:'down',48:'0',49:'1',50:'2',51:'3',52:'4',53:'5',54:'6',55:'7',56:'8',57:'9',65:'a',68:'d',69:'e',81:'q',83:'s',87:'w',187:'=',189:'-'},sa={up:!1,down:!1,left:!1,right:!1,q:!1,w:!1,e:!1,a:!1,s:!1,d:!1,0:!1,1:!1,2:!1,3:!1,4:!1,5:!1,6:!1,7:!1,8:!1,9:!1,"-":!1,"=":!1,space:!1,return:!1,shift:!1,ctrl:!1,tab:!1,alt:!1,click:!1},ta=(a,b=!0)=>{const c=ra[a];return!c||(sa[c]=b),sa[c]};document.body.onkeyup=({keyCode:a})=>ta(a,!1),document.body.onkeydown=({keyCode:a})=>ta(a,!0);let ua=0;const va=(a,b,c)=>({geometry:v(c,0,140,14),render:(a,c)=>{const{fillRectangle:d,strokeRectangle:e,fillText:f,ctx:g}=a;g.font=qa;const{width:h}=g.measureText(b);c.geometry.width=h+10,c.geometry.points=u(c.geometry.width,c.geometry.height),f({textBaseline:'middle',font:qa,style:pa},[-h/2,0],b)},interact:{onMouseMove:()=>ua=a,onMouseDown:()=>ua=a}}),wa={geometry:v([160,120],0,140,40),children:[va(0,'new game',[0,48]),va(1,'continue game',[0,72])],render:(a)=>{const{fillText:b,fillPolygon:c}=a;b({textBaseline:'middle',style:pa,font:'24px '+'Arial Black, Gadget, sans-serif'},[-65,-8],'A L T E R'),400<Date.now()%600&&c('white',0===ua?[-42,48]:[-60,72],[-5,3,5,0,-5,-3]),(sa.up||sa.w)&&(ua=0),(sa.down||sa.s)&&(ua=1)}};let xa=[0,0];const ya=document.querySelector('canvas');ya.width=320,ya.height=240;const{palette:za,render:Aa}=((a,b)=>{const c=Y(a.getContext('2d'));return c.clear(),a.addEventListener(la?'ontouchstart':'mousedown',oa(fa)),a.addEventListener(la?'ontouchmove':'mousemove',oa(ga)),a.addEventListener(la?'ontouchend':'mouseup',oa(ha)),{palette:c,render:()=>ka(new Z,c)(b)}})(ya,{geometry:v([0,0],0,window.innerWidth,window.innerHeight),children:[wa,{render:(a)=>{const{strokeArc:b,fillText:c,ctx:d,moveTo:e,lineTo:f}=a;b('white',xa,0,4),d.strokeStyle='white',d.beginPath(),e(l(xa,[0,-10])),f(l(xa,[0,10])),d.stroke(),d.beginPath(),e(l(xa,[-10,0])),f(l(xa,[10,0])),d.stroke()},interact:{onMouseMove:(a,b)=>xa=[b.x,b.y]}}]});za.ctx.imageSmoothingEnabled=!1;let Ba=0,Ca=0;requestAnimationFrame(function a(){Ba=d(16,Date.now()-Ca),za.clear(),Aa(),Ca=Date.now(),requestAnimationFrame(a)})})();
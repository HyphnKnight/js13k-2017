(function(){'use strict';function a(a,b=8){const c=k(10,b);return Math.round(a*c)/c}function b(b,d){const e=h(d),f=g(d);return[a(b[0]*f-b[1]*e),a(b[0]*e+b[1]*f)]}var c=Math.max,d=Math.min,e=Math.floor,f=Math.abs,g=Math.cos,h=Math.sin,j=Math.sqrt,k=Math.pow;const l=(...a)=>{let b=0;for(let c=a.length-1;0<=c;--c)b+=a[c];return b},m=(a)=>0<a?1:0>a?-1:0,n=(a)=>a*a,o=(a,b)=>(a[0]+=b[0],a[1]+=b[1],a),p=(a,b)=>[a[0]-b[0],a[1]-b[1]],q=(a,b)=>(a[0]-=b[0],a[1]-=b[1],a),r=(a,b)=>(a[0]*=b,a[1]*=b,a),s=(a)=>n(a[0])+n(a[1]),u=(a)=>j(s(a)),v=(a)=>0===a[0]&&0===a[1]?[0,0]:r(a,1/u(a)),w=(a,b)=>r(v(a),b),x=(a,b)=>{const c=[];for(let d=0,e=a.length;d<e;d+=2){const[e,f]=b([a[d],a[d+1]]);c[d]=e,c[d+1]=f}return c},y=(a,b)=>{const c=[];for(let d=0,e=a.length;d<e;d+=2)c[d]=a[d]+b[0],c[d+1]=a[d+1]+b[1];return c},z=(a,b)=>{for(let c=0,d=a.length;c<d;c+=2)a[c]+=b[0],a[c+1]+=b[1];return a},A=(a,b)=>{const c=[];for(let d=0,e=a.length;d<e;d+=2)c[d]=a[d]-b[0],c[d+1]=a[d+1]-b[1];return c},B=(b,d)=>{const e=[],f=h(d),j=g(d);for(let c=0,g=b.length;c<g;c+=2)e[c]=a(b[c]*j-b[c+1]*f),e[c+1]=a(b[c]*f+b[c+1]*j);return e},C=(a,b,c)=>y(B(A(a,b),c),b),D=()=>Math.random().toString(36).substr(2,9)+Math.random().toString(36).substr(2,9),E=(a,b)=>[-a/2,+b/2,-a/2,-b/2,+a/2,-b/2,+a/2,+b/2],F=(a,b=0,c=1,d=1,e=``)=>({id:D(),shape:`Rectangle`,label:e,position:a,rotation:b,width:c,height:d,points:E(c,d)}),G=document.querySelector(`canvas`),H=G.getContext(`2d`),I=320,J=240;let K=G.offsetWidth,L=G.offsetHeight,M=1,N=1;G.width=I,G.height=J;const O=()=>{const{top:a,left:b,width:c,height:d}=G.getBoundingClientRect();K=b,L=a,M=I/c,N=J/d};O(),window.addEventListener(`resize`,O);const P=[0,0],Q=(b)=>(c)=>b.translate(a(c[0],0),a(c[1],0)),R=(a)=>(b)=>a.rotate(b),S=(b)=>(c,d,e)=>b.clearRect(a(c[0],0),a(c[1],0),a(d,0),a(e,0)),T=(a,b)=>()=>S(a)(P,b.width,b.height),U=(b)=>(c)=>b.moveTo(a(c[0],0),a(c[1],0)),V=(b)=>(c)=>b.lineTo(a(c[0],0),a(c[1],0)),W=(b)=>(c,d)=>b.quadraticCurveTo(a(d[0],0),a(d[1],0),a(c[0],0),a(c[1],0)),X=(b)=>(c,d,e,f,g)=>b.arc(a(c[0],0),a(c[1],0),d,e,f,g),Y=(b)=>(c,d,e)=>b.rect(a(c[0],0),a(c[1],0),a(d,0),a(e,0)),Z=(b)=>(c)=>(d,e,f)=>b.drawImage(c,a(d[0],0),a(d[1],0),e,f),$=(b)=>(c)=>(d,e,f,g,h,i)=>b.drawImage(c,a(e[0],0),a(e[1],0),f,g,a(d[0],0),a(d[1],0),h,i),_=(a)=>(b,c=0)=>{const d=[b[0],b[1]],e=A(b,d);a.save(),Q(a)(d),R(a)(c),U(a)([0,0]);for(let d=0;d<e.length;d+=2)V(a)([e[d],e[d+1]]);a.restore()},aa=(a)=>(b,c,d=0)=>{a.save(),Q(a)(b),R(a)(d),U(a)([c[c.length-2],c[c.length-1]]);for(let e=0;e<c.length;e+=2)V(a)([c[e],c[e+1]]);a.restore()},ba=(b)=>(c,d,e,f=0)=>{b.save(),Q(b)(c),R(b)(f),Y(b)([-d/2,-e/2],a(d,0),a(e,0)),b.restore()},ca=(a)=>(b,c,d=100,e=0,f=2*Math.PI,g=!1)=>{a.save(),Q(a)(b),R(a)(c),X(a)([0,0],d,e,f,g),a.restore()},da=(a)=>(b)=>(c,...d)=>{b.save(),b.beginPath(),b.fillStyle=c,a(b)(...d),b.fill(),b.restore()},ea=(a)=>(b)=>(c,...d)=>{b.save(),b.beginPath(),b.strokeStyle=c,a(b)(...d),b.stroke(),b.restore()},fa=da(aa),ga=da(ba),ha=da(_),ia=da(ca),ja=ea(aa),ka=ea(ba),la=ea(_),ma=ea(ca),na=(b)=>(c,d,e)=>{b.save(),b.strokeStyle=c.style||``,b.font=c.font||b.font,b.textAlign=c.textAlign||b.textAlign,b.textBaseline=c.textBaseline||b.textBaseline,b.strokeText(e,a(d[0],0),a(d[1],0),c.maxWidth),b.restore()},oa=(b)=>(c,d,e)=>{b.save(),b.fillStyle=c.style||``,b.font=c.font||b.font,b.textAlign=c.textAlign||b.textAlign,b.textBaseline=c.textBaseline||b.textBaseline,b.fillText(e,a(d[0],0),a(d[1],0),c.maxWidth),b.restore()},pa=(a)=>({ctx:a,canvas:a.canvas,translate:Q(a),rotate:R(a),moveTo:U(a),lineTo:V(a),quadraticCurveTo:W(a),arc:X(a),drawLine:_(a),drawPolygon:aa(a),drawArc:ca(a),drawImage:Z(a),drawSlicedImage:$(a),fillRectangle:ga(a),fillPolygon:fa(a),fillLine:ha(a),fillArc:ia(a),fillText:oa(a),strokePolygon:ja(a),strokeRectangle:ka(a),strokeLine:la(a),strokeArc:ma(a),strokeText:na(a),clearRect:S(a),clear:T(a,a.canvas)});class qa{constructor(){this.position=P,this.rotation=0,this.saved_positions=[],this.saved_rotations=[]}apply(a){const b=[this.position[0],this.position[1]],c=this.rotation;return Object.assign(Object.create(null),a,{id:D(),position:b,rotation:c})}save(){this.saved_positions.push([this.position[0],this.position[1]]),this.saved_rotations.push(this.rotation)}restore(){if(0<this.saved_positions.length){const a=this.saved_positions.pop();a&&(this.position[0]=a[0],this.position[1]=a[1]);const b=this.saved_rotations.pop();!b&&0!==b||(this.rotation=b)}}}const ra=(a,b)=>m((b[2]-b[0])*(a[1]-b[1])-(b[3]-b[1])*(a[0]-b[0])),sa=(a,b,c)=>s(p(a,b))<=n(c),ta=(a,b,c,d)=>f(a[0]-b[0])<=c/2&&f(a[1]-b[1])<=d/2,ua=(a,b)=>{const c=e(b.length/2);for(let d=0;d<c;d+=2){const e=d==c-1?0:d+1;if(-1===ra(a,[b[d],b[d+1],b[e],b[e+1]]))return!0}return!1},va=(a,b,e,f,g)=>ta(a,e,f,g)||sa(e,a,b)||n(a[0]-c(e[0],d(a[0],e[0]+f)))+n(a[1]-c(e[1],d(a[1],e[1]+g)))<n(b),wa=(a,b,c,d,e,g)=>!(f(d[0]-a[0])>b/2+e/2||f(d[1]-a[1])>c/2+g/2),xa=(a,b,d,e)=>{if(ua(a,e)||ua(d,b))return!0;const f=c(b.length,e.length);for(let c=0;c<f;c+=2)if(c<b.length&&ua([b[c],b[c+1]],e)||c<e.length&&ua([e[c],e[c+1]],b))return!0;return!1},ya=new Map,za=new Map,Aa=new Map,Ba=F([0,0],0,window.innerWidth,window.innerHeight,`window`);window.onresize=()=>Object.assign(Ba,F([0,0],0,window.innerWidth,window.innerHeight,`window`));const Ca=((a=Ba)=>(b)=>{const{geometry:c={shape:null}}=b;switch(c.shape){case`Circle`:return va(c.position,c.radius,a.position,a.width,a.height);case`Rectangle`:return wa(c.position,c.width,c.height,a.position,a.width,a.height);case`Polygon`:return xa(c.position,z(C(c.points,[0,0],c.rotation),c.position),a.position,z(C(a.points,[0,0],a.rotation),a.position));default:return!0;}})(Ba),Da=(a,c)=>(d)=>{const{geometry:e,children:f,render:g,interact:h}=d,{ctx:i,translate:j,rotate:k}=c;i.save(),a.save(),e&&(j(e.position),o(a.position,b(e.position,a.rotation)),k(e.rotation),a.rotation+=e.rotation),i.save(),g&&(!e||Ca(a.apply(e)))&&g(c,d),i.restore(),f&&f.forEach(Da(a,c)),h&&(h.onMouseDown?ya.set(d,[d,e&&a.apply(e),h.onMouseDown]):ya.delete(d),h.onMouseMove?za.set(d,[d,e&&a.apply(e),h.onMouseMove]):za.delete(d),h.onMouseUp?Aa.set(d,[d,e&&a.apply(e),h.onMouseUp]):Aa.delete(d)),i.restore(),a.restore()},Ea=`ontouchstart`in window,Fa=(a)=>{if(a.clientX)return[a.clientX,a.clientY];else{const b=a.touches[0];return[b.clientX,b.clientY]}},Ga=(a)=>(b)=>{switch(b.shape){case`Circle`:return sa(a,b.position,b.radius);case`Rectangle`:return ta(a,b.position,b.width,b.height);case`Polygon`:return ua(a,z(C(b.points,[0,0],b.rotation),b.position));default:return!1;}},Ha=(a)=>(b)=>{if(a.size){const c=q(Fa(b),[K,L]);c[0]*=M,c[1]*=N;const d=Ga(c);[...a.values()].filter(([a,b])=>!b||d(b)).forEach(([a,b,d])=>d(a,c))}},Ia={38:`up`,40:`down`,37:`left`,39:`right`,81:`q`,87:`w`,69:`e`,65:`a`,83:`s`,68:`d`,48:`0`,49:`1`,50:`2`,51:`3`,52:`4`,53:`5`,54:`6`,55:`7`,56:`8`,57:`9`,189:`-`,187:`=`,32:`space`,13:`return`,16:`shift`,17:`ctrl`,9:`tab`,18:`alt`},Ja={up:!1,down:!1,left:!1,right:!1,q:!1,w:!1,e:!1,a:!1,s:!1,d:!1,0:!1,1:!1,2:!1,3:!1,4:!1,5:!1,6:!1,7:!1,8:!1,9:!1,"-":!1,"=":!1,space:!1,return:!1,shift:!1,ctrl:!1,tab:!1,alt:!1,click:!1},Ka=(a,b=!0)=>{const c=Ia[a];return c&&(Ja[c]=b),Ja[c]};document.body.onkeyup=({keyCode:a})=>Ka(a,!1),document.body.onkeydown=({keyCode:a})=>Ka(a,!0);const La={dialog:[],position:[0,0]};let Ma=!1,Na=null;const Oa=2,Pa=I-Oa,Qa=J/4,Ra=`#fff`,Sa=`#00f`,Ta=12,Ua=1.2*Ta,Va=Pa-4*Oa,Wa=Qa-4*Oa,Xa=`#fff`,Ya=(a,b,c)=>{const d=[];b=b.toUpperCase(),a.textBaseline=`top`,a.font=`${Ta}px monospace`;const e=b.split(` `);let f=``,g=0,h=0;for(const[i,j]of e.entries()){const b=`${f+j} `,e=a.measureText(b),k=e.width;if(h+b.length>c)return k>Va?(d.push([-Va/2,-Wa/2+g,f]),h+=f.length,d.push([-Va/2,-Wa/2+g+Ua,j.substr(0,c-h)])):d.push([-Va/2,-Wa/2+g,b.substr(0,c-h)]),d;k>Va&&0<i?(d.push([-Va/2,-Wa/2+g,f]),h+=f.length,f=`${j} `,g+=Ua):f=b}return d.push([-Va/2,-Wa/2+g,f]),d},Za={geometry:F([I/2,J-Qa/2],0,Pa,Qa),render:(a,{geometry:b})=>{const{dialog:c}=La,[d]=c;if(!d)return;Na||(Na=Date.now());const{ctx:f,fillRectangle:g,strokeRectangle:h,fillText:i}=a,j=e((Date.now()-Na)/50);g(Sa,[0,0],b.width,b.height),h(Ra,[0,0],b.width,b.height);const[k,l]=d,m=Ya(f,k,j);let n=0;if(l){const[a,b]=l,{width:c}=f.measureText(b),d=c+16+4*Oa,e=-Pa/2+c,j=-Qa/2-2*Oa;g(Sa,[e,j],d,Ua+4*Oa),h(Ra,[e,j],d,Ua+4*Oa),f.font=`${Ta}px monospace`,i({style:Xa},[e-6+4*Oa-d/2,j-Ua/2],a),i({style:Xa},[e-6+4*Oa-d/2+16,j-Ua/2],b),n=Ua/2}m.forEach(([a,b,c])=>{i({style:Xa},[a,b+n],c)}),j>=k.length&&Ja.space&&!Ma?(La.dialog.shift(),Na=null,Ma=!0):!Ja.space&&Ma&&(Ma=!1)},interact:{onMouseDown:()=>{maxChar>=text.length&&(La.dialog.shift(),Na=null)}}},{palette:$a,render:_a}=((a,b)=>{const c=pa(a.getContext(`2d`));return c.clear(),a.addEventListener(Ea?`ontouchstart`:`mousedown`,Ha(ya)),a.addEventListener(Ea?`ontouchmove`:`mousemove`,Ha(za)),a.addEventListener(Ea?`ontouchend`:`mouseup`,Ha(Aa)),{palette:c,render:()=>Da(new qa,c)(b)}})(G,{geometry:F([0,0],0,window.innerWidth,window.innerHeight),children:[Za]});$a.ctx.imageSmoothingEnabled=!1;const ab=([a,b,c])=>([d,e])=>[d+e*(a-d)/(e+b)-a+I/2,J-(0===b+e?0:c*e/(b+e)),j(k(b+e,2)+k(a-d,2))],bb=`\uD83D\uDC69\uD83C\uDFFC\u200D\uD83C\uDF3E`,cb=`\uD83D\uDC6E\uD83C\uDFFF\u200D\u2640\uFE0F`,db=`\uD83D\uDD75\uD83C\uDFFD`,eb=`\uD83D\uDC69\uD83C\uDFFB\u200D\uD83C\uDFA4`,fb=`\uD83C\uDF32`,gb=`\uD83C\uDF33`,hb=`\u2601\uFE0F`,ib=`\uD83C\uDF75`,jb=`\uD83D\uDD37`,kb=(a)=>([b,c],d=0)=>[b,c,d,a],lb=kb(fb),mb=kb(gb),nb=kb(bb),ob=kb(cb),pb=kb(db),qb=kb(eb),rb=kb(hb),sb=kb(ib),tb=kb(jb),ub=[0,120,200];let vb=0,wb=0;const t=F([0,800],0,1e4,1600),xb=F([0,0],0,2*I,2*J),{fillText:yb,fillPolygon:zb,strokePolygon:Ab,fillArc:Bb}=$a,Cb=$a.ctx.createLinearGradient(0,0,200,200);Cb.addColorStop(0,`#5E8C6A`),Cb.addColorStop(1,`#BFB35A`);const Db=$a.ctx.createLinearGradient(0,0,200,200);Db.addColorStop(0,`#69D2E7`),Db.addColorStop(1,`#A7DBD8`);const Eb=[];let Fb=1e3;for(;0<--Fb;)Eb.push((0.5<Math.random()?lb:mb)([5120*Math.random()-2560,1280*Math.random()],0));for(Fb=25;0<--Fb;)Eb.push(rb([1e4*Math.random()-5e3,1e3*Math.random()+3500],30*Math.random()+10));for(Fb=5;0<--Fb;)Eb.push(sb([5120*Math.random()-2560,1280*Math.random()],0));const i=3,Gb=[0,0],Hb=qb([20*Math.random()-10,20*Math.random()-10],0),Ib=nb([20*Math.random()-10,20*Math.random()-10],0),Jb=ob([20*Math.random()-10,20*Math.random()-10],0),Kb=pb([20*Math.random()-10,20*Math.random()-10],0),Lb=tb([20*Math.random()-10,20*Math.random()-10],0),Mb=()=>(a,b)=>{const c=p(La.position,a);u(c)>b&&o(a,w(c,i))};Eb.push(Hb,Ib,Jb,Kb,Lb),requestAnimationFrame(function a(){vb=d(16,Date.now()-wb),ub[2]=40+120*(Date.now()%3e3/3e3),Gb[0]=0,Gb[1]=0,(Ja.w||Ja.up)&&(Gb[1]+=1),(Ja.s||Ja.down)&&(Gb[1]-=1),(Ja.d||Ja.right)&&(Gb[0]+=1),(Ja.a||Ja.left)&&(Gb[0]-=1),o(La.position,w(Gb,i)),La.position[1]=c(La.position[1],5),Hb[0]=La.position[0],Hb[1]=La.position[1];const b=Mb(Hb);b(Ib,20+Date.now()%300/30),b(Jb,45+Date.now()%300/30),b(Kb,70+Date.now()%300/30),b(Lb,90+Date.now()%300/30);const e=La.position[0]-ub[0];f(e)>0.2*I&&(ub[0]+=e-0.2*(m(e)*I)),$a.clear();const g=ab(ub);zb(Db,[0,0],xb.points),zb(Cb,[0,0],x(y(t.points,t.position),g)),[...Eb].map((a)=>[...g(a),a[2],a[3],a[4]]).sort((c,a)=>a[2]-c[2]).forEach(([a,b,c,d,e])=>yb({},[a,b-d],e)),_a(),wb=Date.now(),requestAnimationFrame(a)})})();
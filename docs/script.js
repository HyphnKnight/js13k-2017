(function(){'use strict';function e(e,n){for(let t=-1;++t<e.length;)n(e[t],t,e);return e}function n(e,n,t){for(let d=-1;++d<e.length;)t=n(t,e[d],d,e);return t}function d(e,n=8){const i=z(10,n);return _(e*i)/i}function i(e,n){const i=R(n),t=T(n);return[d(e[0]*t-e[1]*i),d(e[0]*i+e[1]*t)]}function o(e,n){const i=R(n),t=T(n),o=e[0];return e[0]=d(e[0]*t-e[1]*i),e[1]=d(o*i+e[1]*t),e}function a(e,n,i){return e[0]=n,e[1]=i,e}function s(e){const n=[_(e[0]),_(e[1]),_(e[2])],i=[D(n[0]-e[0]),D(n[1]-e[1]),D(n[2]-e[2])];return i[0]>i[1]&&i[0]>i[2]?n[0]=-n[1]-n[2]:i[1]>i[2]?n[1]=-n[0]-n[2]:n[2]=-n[0]-n[1],n}function u(e,n){if(2>e.length)return e;const i=Math.floor(e.length/2);return Ji(u(e.slice(0,i),n),u(e.slice(i),n),n)}function*f(e,n){for(let t=-1;++t<n.length;){const i=ht(n[t]),d=kt(e,i,500);for(;!d();)a(zi,...K(ot,e)),yield}}function*r(e){let n=null;for(Zn.target=null,I(st),st.push(...e);!n;){Ii();const{click:i,mousePosition:t}=Pn;1===i&&(Zn.target=gt(t),W(e,Zn.target)&&(n=Zn.target)),yield}return I(st),n}function*l(e){for(const n=kt(zi,K(ot,e),2e3);!n();)yield}function*g(e,n,i){const t=e(n,i);if(!t.length)return null;const d=yield*r(t);return bt(d)}function*h([{abilities:{attack:{damage:n,range:i}}},,e]){const t=yield*g(wt(vt),e,i);return t?void(qt(t,n),yield*l(t[2])):yield*y(arguments[0])}function*p([{abilities:{defend:{range:n,duration:i,percentage:t}}},,e]){xt(e,n).forEach(([,,,e])=>e.push({type:`shield`,duration:i,percentage:t})),yield}function*m([{type:n,abilities:{magic:{effect:i,range:t}}},,e]){const d=yield*g(wt(yt(null)),e,t);if(!d)return yield*y(arguments[0]);const[{type:s},,o,a]=d;a.push({type:n===s?`heal`:`damage`,effect:i}),yield*l(o)}function*c(e){const[{abilities:{attack:n,defend:i,magic:t}}]=e;let d=null;const o=[n.count&&[`Abuse (${n.count})`,()=>{--n.count,d=h}],i.count&&[`Pretend (${i.count})`,()=>{--i.count,d=p}],t.count&&[`Critique (${t.count})`,()=>{--t.count,d=m}]].filter((e)=>e),a=Mi.push(Gi(o))-1;for(;!d;)yield;Mi.splice(a,1),yield*d(e)}function*y([{abilities:{move:{range:n}}},,e]){const i=lt(e),t=yield*r(ct(i,n));yield*l(e),yield*f(e,pt(i,t))}function*w(e,n){const[{abilities:{aiAttack:{damage:i}}}]=e,t=u(n,([,e])=>e)[0];qt(t,i),yield*l(t[2]),yield}function*x(e,n){const[{abilities:{aiDefend:{duration:i,percentage:t}}}]=e,d=u(n,([,e])=>-e)[0],[,,o,a]=d;yield*l(o),a.push({type:`shield`,duration:i,percentage:t}),yield*l(d[2]),yield}function*v(e,n){const[{type:i,abilities:{aiMagic:{effect:t}}}]=e,d=u(n,([,e])=>-e)[0],[o,,a,s]=d;yield*l(a),s.push({type:i===o.type?`heal`:`damage`,effect:t}),yield*l(d[2]),yield}function*b([{abilities:{aiMove:{range:n,type:i}}},,e]){yield*l(e);const t=u(xt(e,100),([,,e])=>i?vt(e,1).length:xt(e,1).length);t[0]&&(yield*f(e,Vt(e,t[0][2],n)))}function*k(e){const[{abilities:{aiAttack:{range:i}}},,n]=e,t=xt(n,i);t.length?yield*w(e,t):yield*b(e),yield}function*M(e){const[{abilities:{aiMagic:{range:i}}},,n]=e,t=xt(n,i);t.length?yield*v(e,t):yield*b(e),yield}function*C(e){const[{abilities:{aiAttack:{range:i}}},,n]=e,t=xt(n,i),d=vt(n,i);0===t.length?yield*b(e):d.length>t.length?yield*x(e,d):yield*w(e,t),yield}function*E(e){const[{abilities:{aiAttack:{range:i}}},,n]=e,t=xt(n,i),d=vt(n,i);0===t.length?yield*b(e):yield*w(e,[...d,...t]),yield}function*A(e){const[{abilities:{aiAttack:{range:i},aiMagic:{range:t}}},,n]=e,d=xt(n,i),o=vt(n,i),a=[...xt(n,t),...vt(n,t)];1<d.length?yield*w(e,d):1<o.length?yield*x(e,o):a.length?yield*v(e,[...d,...o]):yield*b(e),yield}function*H(e){const[{abilities:{aiAttack:{range:i}}},,n]=e,t=xt(n,i).filter(([,,,e])=>e.find(({type:e})=>`damage`===e));t.length&&(yield*w(e,t)),yield}function*B(e){for(let n=0;;){const i=e[n%e.length];++n;const[,t]=i;0<t&&(yield i)}}function L(e,n,i,t){function*d(){const{value:e}=f.next(),[n,,i]=e;Zn.target=lt(i);for(const e=kt(zi,K(Kt,i),2e3);!e();)yield;if(s=null,n.type){let e;switch(n.name){case`Persecutor`:e=[u.move,u.item];break;default:e=Object.keys(n.abilities).map((e)=>u[e]);}const i=Mi.push(Gi(e));for(;!s;)yield;Mi.splice(i-1,1)}else s=u[n.name.toLowerCase()];yield*s(e),Ft(e);return 0}const o=$t(e,n,i,t);ft(o);let a=null,s=null;const u={move:[`Move`,()=>s=y],attack:[`Avenge`,()=>s=h],defend:[`Protect`,()=>s=p],magic:[`Forget`,()=>s=m],item:[`Use`,()=>s=c],swarmer:k,vamp:M,skeli:C,resentment:E,doubt:H,deceit:A,*harm(){yield*[H,E,A][0|++Qt%9/3]}},f=B(ut);return{init:()=>{zi[2]=340,Mi.push(Ut,Ct),a=d(),Zn.logic=()=>{const{value:o,done:s}=a.next();if(s&&0===o)a=d();else if(s&&1===o)Hi(Zd);else if(s&&2===o){const d=$t(e,n,i,t);ft(d)}}},dismiss:()=>{}}}var j=Math.max,P=Math.min,D=Math.abs,S=Math.PI,T=Math.cos,R=Math.sin,_=Math.round,z=Math.pow;const O=(e,i)=>n(e,(e,n,t,d)=>U(e,i(n,t,d)),[]),X=(e,i=(e)=>!!e)=>n(e,(e,n,t,d)=>i(n,t,d)?U(e,n):e,[]),W=(e,n)=>-1!==e.indexOf(n),Y=(e)=>e.slice(0),I=(e)=>{for(;e.length;)e.pop();return e},U=(e,n,i=0)=>{const t=Y(e);return t.splice(i,0,n),t},q=(e)=>0<e?1:0>e?-1:0,G=(e)=>e*e,F=(e)=>e&&'number'==typeof e,V=(e)=>e&&F(e[0])&&F(e[1]),K=(e,n)=>[e[0]+n[0],e[1]+n[1]],Q=(e,n)=>(e[0]+=n[0],e[1]+=n[1],e),N=(e,n)=>[e[0]-n[0],e[1]-n[1]],Z=(e,n)=>(e[0]-=n[0],e[1]-=n[1],e),$=(e,n)=>[e[0]*n,e[1]*n],J=(e,n)=>(e[0]*=n,e[1]*=n,e),ee=(e)=>G(e[0])+G(e[1]),ne=(e)=>Math.sqrt(ee(e)),ie=(e)=>0===e[0]&&0===e[1]?[0,0]:J(e,1/ne(e)),te=(e,n)=>J(ie(e),n),de=(e)=>{const n=[0,0];for(let t=e.length-1;0<=t;--t)Q(n,e[t]);return n},oe=(e,n)=>{const t=[];for(let d=0,i=e.length;d<i;d+=2)t[d]=e[d]+n[0],t[d+1]=e[d+1]+n[1];return t},ae=(e,n)=>{for(let t=0,i=e.length;t<i;t+=2)e[t]+=n[0],e[t+1]+=n[1];return e},se=(e,n)=>{const t=[];for(let d=0,i=e.length;d<i;d+=2)t[d]=e[d]-n[0],t[d+1]=e[d+1]-n[1];return t},ue=(e,n)=>{const t=[];for(let d=0,i=e.length;d<i;d+=2)t[d]=e[d]*n,t[d+1]=e[d+1]*n;return t},fe=(e,n)=>{const t=[],o=R(n),a=T(n);for(let s=0,i=e.length;s<i;s+=2)t[s]=d(e[s]*a-e[s+1]*o),t[s+1]=d(e[s]*o+e[s+1]*a);return t},re=(e,n,i)=>oe(fe(se(e,n),i),n),le=(e,n)=>{for(let t=0;t<e.length;t+=2)n([e[t],e[t+1]],t/2,e)},ge=(e,n)=>{const t=[];for(let d=0;d<e.length;d+=2)t.push(...n([e[d],e[d+1]],d/2,e));return t},he=(e,n)=>{for(let t=0;t<e.length;t+=2)e.splice(t,2,...n([e[t],e[t+1]],t/2));return e},pe=(e=(e)=>!!e)=>(n)=>e(n),me=pe((e)=>'Point'===e.shape),ce=pe((e)=>'Circle'===e.shape),ye=pe((e)=>'Rectangle'===e.shape),we=pe((e)=>'Polygon'===e.shape),xe=(e,n)=>[-e/2,+n/2,-e/2,-n/2,+e/2,-n/2,+e/2,+n/2],ve=(e,n=0,i=1,t=1,d='')=>({shape:'Rectangle',label:d,position:e,rotation:n,width:i,height:t,points:xe(i,t)});let be=document.createElement('canvas'),ke=be.getContext('2d');const Me=(e,n)=>{be=e;const i=e.getContext('2d',n);i&&(ke=i)},Ce=[0,0],Ee=(e)=>ke.translate(d(e[0],0),d(e[1],0)),Ae=(e)=>ke.rotate(e),He=(e,n,i)=>ke.clearRect(d(e[0],0),d(e[1],0),d(n,0),d(i,0)),Be=()=>He(Ce,be.width,be.height),Le=(e)=>ke.moveTo(d(e[0],0),d(e[1],0)),je=(e)=>ke.lineTo(d(e[0],0),d(e[1],0)),Pe=(e,n)=>ke.quadraticCurveTo(d(n[0],0),d(n[1],0),d(e[0],0),d(e[1],0)),De=(e,n,i,t,o)=>ke.arc(d(e[0],0),d(e[1],0),n,i,t,o),Se=(e,n,i)=>ke.rect(d(e[0],0),d(e[1],0),d(n,0),d(i,0)),Te=(e,n=0)=>{const i=[e[0],e[1]],t=se(e,i);ke.save(),Ee(i),Ae(n),Le(Ce),le(t,je),ke.restore()},Re=(e,n,i=0)=>{const t=[n[n.length-2],n[n.length-1]];ke.save(),Ee(e),Ae(i),Le(t),le(n,je),ke.restore()},_e=(e,n,i=0)=>{const t=ge(n,(e,n,i)=>J(Q(i[2*n-2]?[i[2*n-2],i[2*n-1]]:[i[i.length-2],i[i.length-1]],e),0.5));ke.save(),Ee(e),Ae(i),Le([t[0],t[1]]);for(let d=0;9>=(d+=2);)Pe(t[d]?[t[d],t[d+1]]:[t[0],t[1]],[n[d-2],n[d-1]]);ke.restore()},ze=(e,n,i,t=0)=>{ke.save(),Ee(e),Ae(t),Se([-n/2,-i/2],d(n,0),d(i,0)),ke.restore()},Oe=(e,n=100,i=0,t=0,d=2*S,o=!1)=>{ke.save(),Ee(e),Ae(i),De(Ce,n,t,d,o),ke.restore()},Xe=(e)=>(n,...i)=>{ke.save(),ke.beginPath(),ke.fillStyle=n,e(...i),ke.fill(),ke.restore()},We=(e)=>(n,...i)=>{ke.save(),ke.beginPath(),ke.strokeStyle=n.style||'',ke.lineWidth=n.thickness||1,e(...i),ke.stroke(),ke.restore()},Ye=Xe(Re),Ie=Xe(_e),Ue=Xe(ze),qe=Xe(Te),Ge=Xe(Oe),Fe=We(Re),Ve=We(_e),Ke=We(ze),Qe=We(Te),Ne=We(Oe),Ze=(e,n,i,t=0)=>{if(ke.save(),ke.fillStyle=e.style||'',ke.font=e.font||ke.font,ke.textAlign=e.textAlign||ke.textAlign,ke.textBaseline=e.textBaseline||ke.textBaseline,Ae(t),e.horizontalAlign){const{width:e}=ke.measureText(i);Ee([-e/2,0])}ke.fillText(i,d(n[0],0),d(n[1],0),e.maxWidth),ke.restore()},$e=document.querySelector(`canvas`);Me($e,{alpha:!1}),ke.imageSmoothingEnabled=!1;const Je=160,en=192;let nn=$e.offsetWidth,tn=$e.offsetHeight,dn=1,on=1;$e.width=Je,$e.height=en;const an=()=>{const{top:e,left:n,width:i,height:t}=$e.getBoundingClientRect();nn=n,tn=e,dn=Je/i,on=en/t};an(),document.addEventListener(`DOMContentLoaded`,an),window.addEventListener(`resize`,an);const sn=`\uD83D\uDC69\uD83C\uDFFC\u200D\uD83C\uDF3E`,un=`\uD83D\uDC6E\uD83C\uDFFF\u200D`,fn=`\uD83D\uDD75\uD83C\uDFFD`,rn=`\uD83D\uDC68\uD83C\uDFFB\u200D\uD83C\uDFA4`,ln=`\uD83D\uDC7A`,gn=`\uD83C\uDF2C\uFE0F`,hn=`\uD83C\uDFAD`,pn=`\uD83D\uDC09`,mn=`\uD83E\uDD82`,cn=`\uD83E\uDD87`,yn=`\uD83D\uDC7B`,wn=`\u2620\uFE0F`,xn=`\uD83C\uDF32`,vn=`\uD83C\uDF33`,bn=`\u2601\uFE0F`,kn=`\u26F0\uFE0F`,Mn=`\uD83C\uDF37`,Cn=`\uD83D\uDC49\uD83C\uDFFB`,En=`\uD83C\uDF75`,An=`\uD83D\uDC8E`,Hn=`\uD83D\uDDA4`,Bn=`\uD83D\uDC97`,Ln=`\uD83C\uDF31`,jn={38:`up`,40:`down`,37:`left`,39:`right`,87:`w`,65:`a`,83:`s`,68:`d`,32:`space`,13:`return`},Pn={up:0,down:0,left:0,right:0,w:0,a:0,s:0,d:0,space:0,return:0,mousePosition:null,click:null},Dn=(e,n=1)=>{const i=jn[e];return i&&(0===n||2!==Pn[i])&&(Pn[i]=n),Pn[i]};document.body.onkeyup=({keyCode:e})=>Dn(e,0),document.body.onkeydown=({keyCode:e})=>Dn(e,1);const Sn=()=>{const e=Object.keys(Pn);for(let n=-1;++n<e.length;)Pn[e[n]]=1===Pn[e[n]]?2:Pn[e[n]]};document.body.onmousedown=()=>Pn.click=1,document.body.onmouseup=()=>Pn.click=0;const Tn=({clientX:e,clientY:n,touches:i})=>i?[i[0].clientX,i[0].clientY]:[e,n];document.body.onmousemove=(e)=>{const n=Z(Tn(e),[nn,tn]);n[0]*=dn,n[1]*=on,Pn.mousePosition=n};const Rn=(e)=>()=>{const n=[0,0];return(Pn.up||Pn.w)&&++n[1],(Pn.down||Pn.s)&&--n[1],(Pn.left||Pn.a)&&--n[0],(Pn.right||Pn.d)&&++n[0],te(n,e)},_n=`#fff`,zn=`#00f`,On=`Arial Black, Gadget, sans-serif`,Xn=`"Lucida Console", Monaco, monospace`,Wn=12,Yn=1.1*Wn,In=`24px ${On}`,Un=`${Wn}px ${Xn}`,qn={font:`6px mono`},Gn={style:_n,font:`10px mono`},Fn={style:_n},Vn=2,Kn={style:_n,thickness:Vn},Qn=[0,-Vn/2],Nn=(e,n,i,t=0)=>{Ue(zn,K(e,Qn),n,i*Yn+t),Ke(Kn,K(e,Qn),n,i*Yn+t)},Zn={dialog:[],position:[-545,700],target:null,logic:null,miasma:-550},$n=(e)=>e&&'number'==typeof e,Jn=[0,0];class ei{constructor(){this.apply=(e)=>Object.assign(Object.create(null),e,{position:[...this.position],rotation:this.rotation}),this.position=Jn,this.rotation=0,this.saved_positions=[],this.saved_rotations=[]}save(){this.saved_positions.push([this.position[0],this.position[1]]),this.saved_rotations.push(this.rotation)}restore(){if(0<this.saved_positions.length){const e=this.saved_positions.pop();V(e)&&(this.position[0]=e[0],this.position[1]=e[1]);const n=this.saved_rotations.pop();$n(n)&&(this.rotation=n)}}}const ni=(e,n)=>q((n[2]-n[0])*(e[1]-n[1])-(n[3]-n[1])*(e[0]-n[0])),ii=(e,n,i)=>ee(N(e,n))<=G(i),ti=(e,n,i,t)=>D(e[0]-n[0])<=i/2&&D(e[1]-n[1])<=t/2,di=(e,n)=>{for(let t=0,i=n.length,d=0,o=0;;){if(d=t==i-2?0:t+2,o=ni(e,[n[t],n[t+1],n[d],n[d+1]]),-1===o)return!1;if(t+=2,t>i-2)break}return!0},oi=(e,n,i,t,d)=>ti(e,i,t,d)||ii(i,e,n)||G(e[0]-j(i[0],P(e[0],i[0]+t)))+G(e[1]-j(i[1],P(e[1],i[1]+d)))<G(n),ai=(e,n,i,t,d,o)=>!(D(t[0]-e[0])>n/2+d/2||D(t[1]-e[1])>i/2+o/2),si=(e,n,i,t)=>{if(di(e,t)||di(i,n))return!0;const d=j(n.length,t.length);for(let o=0;o<d;o+=2)if(o<n.length&&di([n[o],n[o+1]],t)||o<t.length&&di([t[o],t[o+1]],n))return!0;return!1},ui=new Map,fi=new Map,ri=new Map;let li=ve([0,0],0,window.innerWidth,window.innerHeight,'window');window.onresize=()=>Object.assign(li,ve([0,0],0,window.innerWidth,window.innerHeight,'window'));const gi=((e=li)=>(n)=>{const{geometry:i={shape:null}}=n;switch(i.shape){case'Circle':return oi(i.position,i.radius,e.position,e.width,e.height);case'Rectangle':return ai(i.position,i.width,i.height,e.position,e.width,e.height);case'Polygon':return si(i.position,ae(re(i.points,[0,0],i.rotation),i.position),e.position,ae(re(e.points,[0,0],e.rotation),e.position));default:return!0;}})(li),hi=(n)=>(t)=>{const{geometry:d,children:o,render:a,interact:s}=t;ke.save(),n.save(),!d||(Ee(d.position),Q(n.position,i(d.position,n.rotation)),Ae(d.rotation),n.rotation+=d.rotation),ke.save(),a&&(!d||gi(n.apply(d)))&&a(t),ke.restore(),o&&e(o,hi(n)),s&&(s.onMouseDown?ui.set(t,[t,d&&n.apply(d),s.onMouseDown]):ui.delete(t),s.onMouseMove?fi.set(t,[t,d&&n.apply(d),s.onMouseMove]):fi.delete(t),s.onMouseUp?ri.set(t,[t,d&&n.apply(d),s.onMouseUp]):ri.delete(t)),ke.restore(),n.restore()},pi='ontouchstart'in window,mi=(e)=>pe((e)=>!!e.clientX)(e)?[e.clientX,e.clientY]:[e.touches[0].clientX,e.touches[0].clientY],ci=(e)=>(n)=>{switch(n.shape){case'Circle':return ii(e,n.position,n.radius);case'Rectangle':return ti(e,n.position,n.width,n.height);case'Polygon':return di(e,ae(re(n.points,[0,0],n.rotation),n.position));default:return!1;}};let yi=0,wi=0,xi=1,vi=1;const bi=()=>{const{top:e,left:n,width:i,height:t}=be.getBoundingClientRect();yi=n,wi=e,xi=be.width/i,vi=be.height/t};bi(),document.addEventListener('DOMContentLoaded',bi),window.addEventListener('resize',bi);const ki=(n)=>(i)=>{if(!!n.size){const t=Z(mi(i),[yi,wi]);t[0]*=xi,t[1]*=vi;const d=ci(t);e(X([...n.values()],([e,n])=>d(n)),([e,n,i])=>i(e,t))}},Mi=[],Ci=()=>{for(;Mi.length;)Mi.pop()},Ei=((e,n)=>(Me(e),e.addEventListener(pi?'ontouchstart':'mousedown',ki(ui)),e.addEventListener(pi?'ontouchmove':'mousemove',ki(fi)),e.addEventListener(pi?'ontouchend':'mouseup',ki(ri)),()=>{ui.clear(),fi.clear(),ri.clear(),hi(new ei)(n)}))($e,{geometry:ve([$e.width/2,$e.height/2],0,$e.width,$e.height),children:Mi,render({geometry:e}){e.position[0]=$e.width/2,e.position[1]=$e.height/2,e.width=$e.width,e.height=$e.height,e.points=xe(e.width,e.height)}});let Ai;const Hi=(e)=>{Ci(),e.init(),Ai&&Ai.dismiss(),Ai=e};let Bi=null,Li=0;const ji=Je-Vn,Pi=5*Yn,Di=ji-4*Vn,Si=Pi-4*Vn,Ti=(e,n,i)=>{const t=[];n=n.toUpperCase(),e.textBaseline=`top`,e.font=`${Wn}px monospace`;const d=n.split(` `);let o=``,a=0,s=0;for(const[u,f]of d.entries()){const n=`${o+f} `,d=e.measureText(n),r=d.width;if(s+n.length>i)return r>Di?(t.push([-Di/2,-Si/2+a,o]),s+=o.length,t.push([-Di/2,-Si/2+a+Yn,f.substr(0,i-s)])):t.push([-Di/2,-Si/2+a,n.substr(0,i-s)]),t;r>Di&&0<u?(t.push([-Di/2,-Si/2+a,o]),s+=o.length,o=`${f} `,a+=Yn):o=n}return t.push([-Di/2,-Si/2+a,o]),t},Ri={geometry:ve([0,en/2-Pi/2],0,ji,Pi),render:({geometry:e})=>{const[n]=Zn.dialog;if(!n)return;if(`function`==typeof n)return Zn.dialog.shift()();Bi||(Bi=Date.now()),Li=0|(Date.now()-Bi)/50,Nn([0,0],e.width,0,e.height);const[i,t]=n,d=Ti(ke,i,Li);let o=0;if(t){const[e,n]=t,{width:i}=ke.measureText(n),d=i+16+4*Vn,a=-ji/2+i,s=-Pi/2-2*Vn;Nn([a,s],d,1,4*Vn),ke.font=`${Wn}px monospace`,Ze(Fn,[a-6+4*Vn-d/2,s-Yn/2-Vn],e),Ze(Fn,[a-6+4*Vn-d/2+16,s-Yn/2-Vn],n),o=0.33*Yn}d.forEach(([e,n,i])=>{Ze(Fn,[e,n+o],i)}),(1===Pn.space||1===Pn.click)&&(Li<i.length?Bi=1:(Zn.dialog.shift(),Bi=null))}},_i=500,zi=[0,0,240],Oi=(e)=>{const[n,i]=N(e,zi),t=zi[2],d=i+_i;let o,a=n+i*-n/(i+_i)+Je/2;return 0>d?(o=en+t*i/d,a=n):0<d?o=en-t*i/d:(o=en,a=n),[a,o,z(_i+i,2)+z(-n,2)]},Xi=(e)=>Oi(e).slice(0,2),Wi=([e,n])=>{const i=zi[2],t=_i/(-i/(n-en)-1);return Q([-(Je*t+Je*_i+-2*e*t+-2*e*_i)/(2*_i),t],zi)},Yi=Rn(3),Ii=()=>Q(zi,Yi()),Ui=[],qi=(e,n)=>{const i=xe(2*n,2*n),t=oe(i,e);Ui.push({position:e,radius:n,getBase:()=>ge(t,Xi),getShoreLine:(n)=>he(ae(ue(i,n),e),Xi),collision:(i,t=1)=>ii(i,e,n*t)})};for(let e=-1,n=-1;9>++e;){const i=D(e-4);for(;++n<9-i;)qi([100*(e-5),1e3+100*(i/2+n-5)],75+50*Math.random());n=0}const Gi=(e)=>{let n=Je/3;const i=Yn*e.length+2*Vn;let t=Je/2-n/2-Vn/2;let d=0;const o=[];for(const[t,[a,s]]of e.entries()){const e=a.toUpperCase(),{width:u}=ke.measureText(e);n=j(n,u+4*Vn),o.push({geometry:ve([-n/2+2*Vn,-i/2+Yn+t*Yn-Vn],0,n,Yn),render(){Ze(Fn,[0,0],e),d===t&&Ze({},[-13,0],Cn)},interact:{onMouseDown:s,onMouseMove(){d=t}}})}for(const i of o)i.geometry.position[0]=-n/2+2*Vn;return t=Je/2-n/2-Vn/2,{geometry:ve([t,en/2-i/2],0,n,i),children:o,render(){Nn([0,0],n,0,i),1===Pn.down&&d<e.length-1?d++:1===Pn.up&&0<d&&d--,(1===Pn.space||1===Pn.return)&&e[d][1]()}}},Fi=[[0,1,-1],[1,0,-1],[1,-1,0],[-1,1,0],[0,-1,1],[-1,0,1]],Vi=(e)=>([n,i])=>{const t=(e.length-1)/2,d=i+t,o=n+t+P(0,d-t);return e[d]?e[d][o]:null},Ki=(e)=>[1.7320508075688772*(e[0]+e[1]/2),3/2*e[1]],Qi=(e)=>{const[n,i]=e,t=[0,0,0];return t[0]=1.7320508075688772*n/3-i/3,t[1]=2*i/3,t[2]=-(t[0]+t[1]),s(t)},Ni=(e)=>[e[0],e[1],-e[0]-e[1]],Zi=(e,n)=>(D(e[0]-n[0])+D(e[1]-n[1])+D(e[2]-n[2]))/2,$i=(e)=>(n)=>(i)=>Vi(e)([n[0]+i[0],n[1]+i[1]]),Ji=(e,n,i)=>{const t=[];for(;e.length&&n.length;)(i(e[0])||0)<=(i(n[0])||0)?t.push(e.shift()||e[0]):t.push(n.shift()||n[0]);for(;e.length;)t.push(e.shift()||e[0]);for(;n.length;)t.push(n.shift()||n[0]);return t},et=(e,n=Date.now()%e)=>()=>P((Date.now()+n)%e/e,1),nt=(e,n)=>{const i=Date.now();let t=0;const d=et(e,n);return()=>Date.now()-i<e?t=j(t,d()):1},it=(e)=>.5>e?8*e*e*e*e:1-8*--e*e*e*e;var tt={child:{name:`Child`,emoji:sn,type:!0,maxHealth:40,abilities:{move:{range:3},magic:{range:4,effect:10,duration:5}}},avenger:{name:`Avenger`,emoji:rn,type:!0,maxHealth:80,abilities:{move:{range:3},attack:{name:`Avenge`,range:1,damage:25}}},protector:{name:`Protector`,emoji:un,type:!0,maxHealth:100,abilities:{move:{range:2},defend:{range:1,duration:1,percentage:1}}},persecutor:{name:`Persecutor`,emoji:fn,type:!0,maxHealth:60,abilities:{move:{range:5},attack:{count:10,range:4,damage:30},defend:{count:10,range:3,percentage:0.5,duration:3},magic:{count:10,range:1,effect:50,duration:1},reset:{count:3}}},swarmer:{name:`Swarmer`,emoji:mn,type:!1,maxHealth:30,abilities:{aiMove:{type:!0,range:3},aiAttack:{range:1,damage:10}}},vamp:{name:`Vamp`,emoji:cn,type:!1,maxHealth:40,abilities:{aiMove:{type:!1,range:5},aiMagic:{range:1,duration:1,effect:5}}},skeli:{name:`Skeli`,emoji:wn,type:!1,maxHealth:40,abilities:{aiMove:{type:!1,range:5},aiAttack:{range:1,damage:20},aiDefend:{range:1,duration:1,percentage:0.25}}},resentment:{name:`Resentment`,emoji:ln,isBoss:!0,type:!1,maxHealth:60,abilities:{aiMove:{type:!1,range:5},aiAttack:{range:1,damage:40}}},doubt:{name:`Doubt`,emoji:gn,isBoss:!0,type:!1,maxHealth:120,abilities:{aiAttack:{range:10,damage:30}}},deceit:{name:`Deceit`,emoji:hn,isBoss:!0,type:!1,maxHealth:120,abilities:{aiMove:{type:!0,range:3},aiAttack:{range:1,damage:20},aiMagic:{range:3,effect:10,duration:3},aiDefend:{range:2,duration:2,percentage:0.25}}},harm:{name:`Harm`,emoji:pn,isBoss:!0,type:!1,maxHealth:120,abilities:{aiMove:{type:!0,range:3},aiAttack:{range:3,damage:20},aiMagic:{range:3,effect:10,duration:3},aiDefend:{range:2,duration:2,percentage:0.25}}}};const ot=[0,-150],at=((e)=>{const n=[];for(let i=0;i<2*e+1;++i){const t=i<=e?e+1+i:3*e+1-i;for(let d=0;d<t;++d)n[i]||(n[i]=[]),n[i][d]=Ni([-e-P(0,i-e)+d,i-e])}return n})(5),st=[],ut=[],ft=(e)=>{I(ut),ut.push(...e.map(([e,n])=>[tt[e],tt[e].maxHealth,J(Ki(n),20),[]]))},rt=((e)=>(n)=>Vi(e)(Qi(n)))(at),lt=(e)=>rt($(e,1/20)),gt=(e)=>lt(Wi(e)),ht=(e)=>J(Ki(e),20),pt=((n,i,t,d=Infinity)=>(o,a)=>{let s=[[o,t(a,o)]];const f=new Map,r=new Map;f.set(o,null),r.set(o,0);let l=o;for(;s.length;){const[o]=s.shift(),l=r.get(o);if(o===a)break;if(l>=d)return null;e(n(o),(e)=>{const n=l+i(o,e),d=r.get(e);if(!d||n<d){r.set(e,n);const i=n+t(a,e);s.push([e,i]),f.set(e,o)}}),s=u(s,([,e])=>e)}const g=[];for(l=a;l!==o;)g.unshift(l),l=f.get(l);return g})(((e)=>(n)=>X(O(Fi,$i(e)(n))))(at),(e,n)=>bt(n)?40:1,(e,n)=>Zi(e,n),1e3),mt=((e)=>(n,i)=>{const t=[];for(let d=-i;d<=i;++d){const o=P(i,-d+i);for(let a=j(-i,-d-i);a<=o;++a)t.push(Vi(e)([d+n[0],-d-a+n[1]]))}return X(t)})(at),ct=(e,n)=>mt(e,n).filter((e)=>!ut.find(([,n,i])=>lt(i)===e&&0<n)),yt=(e)=>(n,i)=>ut.filter(([t,d,o])=>(null===e||t.type===e)&&0<d&&Zi(lt(n),lt(o))<=i),wt=(e)=>(n,i)=>e(n,i).map(([,,e])=>lt(e)),xt=yt(!0),vt=yt(!1),bt=(e)=>ut.find(([,n,i])=>lt(i)===e&&0<n),kt=(e,n,i)=>{const t=[...e],d=Z([...n],t),o=nt(i);return()=>{const n=it(o());return a(e,...Q($(d,n),t)),1===n}},Mt=1.2*12,Ct={geometry:ve([0,-en/2+Mt/2],0,Je,Mt),render(){var e=Math.ceil;const n=bt(Zn.target);if(n){const[i,t]=n,{maxHealth:d,name:o}=i;let a=e(d/10)+1,s=e(t/10)+1;for(;0<=--a;)Ze(qn,[Je/2-11-8*a,2],Hn);for(;0<=--s;)Ze(qn,[Je/2-11-8*s,2],Bn);Ze(Gn,[-Je/2,2],o)}}},Et=(e,n)=>(i,t,d,o=!0)=>{const a=0|500*Math.random(),s=1800+(0|1e3*Math.random()),u=xe(2*i,2*i),f=oe(u,t);let r;const l={display:o},g=(e)=>(n)=>ee(N(n,t))<=e*e;return{propCollision:g(2*i),collision:g(0.5*i),test:(e)=>{l.display&&d&&g(i)(e)&&(d(),d=null)},render:()=>{if(r=ge(f,Xi),!!l.display){Ie(e,[0,0],r);const d=(Date.now()+a)%s/(12*i);Ve({style:n,thickness:1},[0,0],ge(ae(ue(u,1<d?0:d),t),Xi)),Ve({style:n,thickness:2},[0,0],r)}},toggle:l}},At=Et(`#F9CDAD`,`#FE4365`),Ht=Et(`#EDE574`,`#F9D423`),Bt=Et(`#69D2E7`,`#E0E4CC`),Lt=Et(`#CFF09E`,`#3B8686`),jt=Et(`#EDEDF2`,`#CFD5E1`),Pt=Et(`#4F364C`,`#8F9E6F`),Dt=`#8f9e6f`,St=xe(15,15),Tt=(e,n=1)=>he(oe(1===n?St:xe(15*n,15*n),J(Ki(e),20)),Xi),Rt=(e)=>{e&&(Zn.target===e?Ve({style:Dt},[0,0],Tt(e,P(Date.now()%2e3/1e3),1)):Ve({style:Dt},[0,0],Tt(e)))},_t=({name:e,isBoss:n})=>({horizontalAlign:!0,font:`${n?`Harm`===e?30:20:12}px mono`}),zt=(e,n)=>!!e.find(({type:e})=>e===n),Ot=(e,n,i,t)=>(d,o)=>zt(o,e)?Ze({style:n,font:`6px mono`},[d[0]+t,d[1]+5],i):null,Xt=[Ot(`shield`,`#0064fa`,`S`,-5),Ot(`heal`,`#32fa00`,`H`,0),Ot(`damage`,`#fa3200`,`D`,5)],Wt=([e,n,i,t])=>{if(0<n){const n=Xi(i);Ze(_t(e),n,e.emoji),Xt.forEach((e)=>e(n,t))}else if(e.type);},Yt=ke.createLinearGradient(0,0,100,100);Yt.addColorStop(0,`#F07241`),Yt.addColorStop(1,`#601848`);const It=Pt(200,[0,0]);var Ut={geometry:ve([-Je/2,-en/2],0,Je,en),render(){Ue(Yt,[0,0],2*Je,2*en,0),It.render(),[...st,Zn.target].forEach(Rt),u([...ut],([,,[,e]])=>-e).forEach(Wt)}};const qt=(e,n)=>{const[,,,i]=e,t=i.find(({type:e})=>`shield`===e);t&&(n*=1-t.effect),e[1]-=n},Gt=(e,n)=>e[1]=P(e[1]+n,e[0].maxHealth),Ft=(e)=>{const[,,,n]=e;e[3]=n.map((e)=>!(0>--e.duration)&&e).filter((e)=>e),n.forEach((n)=>{switch(n.type){case`damage`:qt(e,n.effect);break;case`heal`:Gt(e,n.effect);}})},Vt=(e,n,i)=>{const t=pt(lt(e),lt(n)).splice(0,i);return t.pop(),t},Kt=[0,-150];let Qt=0;const Nt=[[`avenger`,[0,0,0]],[`child`,[1,0,-1]],[`protector`,[-1,1,0]],[`persecutor`,[-1,0,1]]],Zt=()=>lt(o(J([0,1],60+100*Math.random()),Math.random()*S)),$t=(e,n,t,d)=>{const o=[...Nt];let a=-1;for(const i=j(e,n,t);++a<i;)a<e&&o.push([`swarmer`,Zt()]),a<n&&o.push([`vamp`,Zt()]),a<t&&o.push([`skeli`,Zt()]);return d&&o.push([d,Zt()]),o},Jt=(e,n=1)=>([i,t],d=0)=>[i,t,d,e,n],ed=Jt(xn,2),nd=Jt(vn,2),id=Jt(sn),td=Jt(un),dd=Jt(fn),od=Jt(rn),ad=Jt(bn),sd=Jt(kn,4),ud=Jt(Mn,0.5),fd=Jt(Ln,0.25),rd=Jt(yn),ld=Jt(En),gd=Jt(An),hd=(e,n,i,t,d,o)=>{const a=j(...d.map((e)=>e[1][e[1].length-1][0])),s=(e,n)=>{const{width:i,height:t}=ke.measureText(e);return{geometry:ve([0,0],0,i,t),render(){Ze(n,[0,0],e)}}},u=d.map((e)=>{let n=e[0];const{fontOptions:o={},x:i,y:t,rotation:d}=e[1][0][1];return`string`==typeof n&&(n=s(n,o)),n.geometry.position=[i,t],n.geometry.rotation=d,n});let f=!1;const r=Date.now();return{geometry:ve([e,n],0,i,t),children:u.map((e,n)=>0===d[n][1][0][0]?e:{}).reverse(),render({children:e}){const n=Date.now(),l=n-r;if(l>a)return void(o&&!f&&(o(),f=!0));for(const[n,o]of d.entries()){const d=o[1];let a={};for(const[o,[f,r]]of d.entries()){if(l>f){if(0===o&&(e[e.length-1-n]=u[n]),r.remove){e[e.length-1-n]={};break}else{a={time:f,keyframe:r};continue}}else if(0===o)break;0===o&&(a={time:f,keyframe:r});let d=(l-a.time)/(f-a.time);for(const e in 0.995<d&&(d=1),a.keyframe){const n=a.keyframe[e];`function`==typeof n&&(a.keyframe[e]=n(1))}r.symbol?(`string`==typeof r.symbol&&(r.symbol=s(r.symbol,r.fontOptions)),e[e.length-1-n]=r.symbol):e[e.length-1-n]=u[n];const g=r.symbol?Object.assign({},u[n],r.symbol):u[n],{x:h,y:p,rotation:m}=a.keyframe,{x:c,y:y,rotation:w}=r,{geometry:x}=g,{position:v}=x;`function`==typeof c?v[0]=c(d,h,p,m,i,t):void 0!==c&&(v[0]=h+(c-h)*d),`function`==typeof y?v[1]=y(d,h,p,m,i,t):void 0!==y&&(v[1]=p+(y-p)*d),`function`==typeof w?x.rotation=w(d,h,p,m,i,t):void 0!==w&&(x.rotation=m+(w-m)*d);break}}}}},pd=[rn,un,fn,sn].map((e,n)=>[e,[[2e3+800*n,{x:Je/4,y:en/2}],[2e3+800*n+2e3,{x:0,y:0}],[2e3+800*n+2800,{x:0,y:0}],[2e3+800*n+3800,{x:0,y:-en}]]]),md=[...pd,[An,[[6e3+800*pd.length,{x:Je/4,y:en/2}],[6e3+800*pd.length+2e3,{x:0,y:0}],[6e3+800*pd.length+2800,{x:0,y:0}],[6e3+800*pd.length+3800,{x:0,y:-en}]]],[`~ fin    Rafe Lepre, Brian Blakely`,[[6e3+800*pd.length+4800,{fontOptions:{style:`#000`},x:-Je/2+2,y:en/2-4}],[6e3+800*pd.length+4900,{}]]],[{geometry:ve([0,0],0,Je,en),render(){Ue(`#fff`,[0,0],Je,en,0)}},[[0,{x:0,y:0,rotation:0}]]]];var cd={init:()=>{Mi.push(hd(0,0,Je,en,md))},dismiss:()=>{}};let yd=[];const wd=he(ae(xe(1e4,1600),[0,800]),Xi),xd=((e)=>J(de(e),1/e.length))(Ui.map(({position:e})=>e)),vd=j(...Ui.map(({position:e})=>ne(N(e,xd))))+200,bd=od([...Zn.position],0),kd=td(Q([0,10],Zn.position),0),Md=id(Q([-10,0],Zn.position),0),Cd=dd(Q([10,0],Zn.position),0),Ed=gd(Q([0,-10],Zn.position),0);yd.push(bd,kd,Md,Cd,Ed);const Ad=(e)=>{Zn.miasma+=60*e,yd=yd.filter(([e,,,n])=>n!==Mn||e>Zn.miasma)};let Hd=!1,Bd=0;const Ld=(e,n,i)=>e(25,i,()=>Zn.dialog.push(...n)),jd=[bd[3],`Avenger`],Pd=[Cd[3],`Persecutor`],Dd=[kd[3],`Protector`],Sd=[Md[3],`Child`],Td=[Ed[3],`Origin`],Rd=[],_d=[[At,[[`I hate them, and everything they created.`,jd],[`I'll take them with me if I can.`,jd]]],[Lt,[[`It couldn't hurt to try, right? Once - only once.`,Pd]]],[Ht,[[`I have a new coat, with stars!`,Sd],[`I'm going to do all my favorite things today.`,Sd]]],[Bt,[[`It takes so much effort at times, but we're worth all of it.`,Dd]]],[Pt,[[`You take out groceries one-by-one, and stack them in the pantry.`,Td],[`At least three of your things were already in there.`,Td],()=>{Ad(4),Hi(L(8,0,0,`resentment`))}]],[Ht,[[`I made a lot of new friends.`,Sd]]],[Bt,[[`Two years and we're beginning to take a turn.`,Dd]]],[Lt,[[`Liars can never get close to me.  I'm a liar too.`,Pd]]],[Pt,[[`Some of your friends only know one of you.`,Td],()=>{Ad(3),Hi(L(6,6,0,`doubt`))}]],[Lt,[[`That little piss hung up on me.`,Pd]]],[Ht,[[`He said he doesn't like me anymore.`,Sd],[`I was too hard to be around.`,Sd]]],[Pt,[[`You went to his house for dinner.`,Td],[`Everyone was was confused when you arrived.`,Td],[`You were afraid.`,Td],()=>{Ad(2),Hi(L(0,8,2,`deceit`))}]],[Ht,[[`I walked to school and back home every day.`,Sd],[`I stayed close behind the older kids.`,Sd],[`They threw cupcake and candy wrappers right on the sidewalk.`,Sd],[`I picked them up.`,Sd],[`The one watching wasn't someone I knew.`,Sd],[`I listened to his stories.`,Sd]]],[Pt,[[`When he kissed you, it wasn't the same.`,Td],()=>{Ad(100),Hi(L(6,6,3,`harm`))}]],[jt,[()=>{yd=[],Rd.splice(0,Rd.length-1),Bd=Date.now(),Hd=!0}]]];{const e=_d.length+4;for(let n=-1;++n<e;){const[e,i]=_d.shift();Rd.push(Ld(e,i,[60*n-550,0|700+300*Math.random()])),e===Pt&&++n}}const zd=[[ed,50],[nd,50],[sd,10],[ud,500],[fd,300]],Od=()=>Q(J(o([0,1],2*Math.random()*S),vd*Math.random()),xd),Xd=(e)=>ii(e,xd,vd)&&!!Ui.find(({collision:n})=>n(e)),Wd=(e)=>Xd(e)&&!Rd.find(({propCollision:n})=>n(e)),Yd=()=>{let e=Od();for(;!Wd(e);)e=Od();return e},Id=j(...zd.map(([,e])=>e));for(let e=-1;++e<Id;)for(const[n,i]of zd)e<i&&yd.push(n(Yd(),0));const Ud=`#69D2E7`,qd=`#fff`,Gd=`#90b4ec`;Ad(5);const Fd=()=>{Ue(Gd,[0,0],2*Je,2*en,0),Ye(Ud,[0,0],wd);const e=1.2-D(Date.now()%7200/3600-1)/10;if(Ui.forEach(({getShoreLine:n})=>Ve({style:qd,thickness:4},[0,0],n(e))),Ui.forEach(({getShoreLine:n})=>Ie(`#fafac8`,[0,0],n(e))),Ui.forEach(({getBase:e})=>Ie(`#00c864`,[0,0],e())),Hd){const e=Date.now()-Bd;if(3e3<e)return void Hi(cd);Rd.push(jt(25+175*(e/3e3),[350,900]))}for(const e of Rd)e.render(),e.test(Zn.position);yd.map((e)=>[...Oi(e),e[2],e[3],e[4]]).sort((e,n)=>n[2]-e[2]).forEach(([e,n,i,t,d,o])=>Ze({font:`${0|12*o*(1-2*(i-10994)/8248748)}px monospace`},[e,n-t],d))},Vd=()=>Pn.space?6:3,Kd=(e,n)=>{const i=N(Zn.position,e);ne(i)>n&&Q(e,te(i,Vd()))},Qd=Rn(1);var Nd=()=>{let e;const n=Vd(),i=Qd();if(0.5<ee(i)&&(Zn.target=null),null!==Zn.target){const i=N(Zn.target,Zn.position);3>ee(i)&&(Zn.target=null),e=te(i,n)}else e=te(i,n);const t=K(Zn.position,e);Xd(t)&&t[0]<Zn.miasma&&!Zn.dialog.length&&a(Zn.position,...t),a(bd,...Zn.position),Kd(kd,20+Date.now()%300/30),Kd(Md,45+Date.now()%300/30),Kd(Cd,70+Date.now()%300/30),Kd(Ed,90+Date.now()%300/30);const d=Zn.position[0]-zi[0];D(d)>0.2*Je&&(zi[0]+=d-0.2*(q(d)*Je)),a(zi,...K(Zn.position,[0,-100]))},Zd={init:()=>{Mi.push(Ri),Zn.logic=(e)=>{Nd(e),Fd(e),Pn.click&&!Zn.dialog.length&&(Zn.target=Wi(Pn.mousePosition))}},dismiss:()=>{}};const $d=()=>{Hi(Zd)},Jd={textBaseline:`middle`,style:_n,font:In,horizontalAlign:!0},eo={geometry:ve([0,0],0,Je,en),render(){(1===Pn.space||1===Pn.return)&&$d(),Ue(`#00f`,[0,0],Je,en,0),Ze(Jd,[0,0],`A L T E R`),Ze(Jd,[0,-24],An),Ze({style:_n,font:Un},[-28,51],`new game`),400<Date.now()%600&&Ye(`white`,[-42,48],[-5,3,5,0,-5,-3])},interact:{onMouseDown:$d}};let no=0,dt=0;const t=()=>{const e=ke.getImageData(0,0,Je,en),n=e.data;for(let e=-1;++e<n.length;)n[e]=75*(0|n[e]/75);ke.putImageData(e,0,0)};Hi({init:()=>{Mi.push(eo),Zn.logic=null},dismiss:()=>{}}),((e)=>{let n=!0;return requestAnimationFrame(function i(){no=P(16,Date.now()-dt),n&&e(no),dt=Date.now(),requestAnimationFrame(i)}),()=>n=!n})((e)=>{Be(),Zn.logic&&Zn.logic(),Ei(e),Sn(),t()})})();
